

# 六、清理 PDF 文件中的数据

在上一章中，我们发现了将我们想要的数据和我们不想要的数据分开的不同方法。我们认为数据清理过程有点像做鸡汤，我们的目标是保留肉汤，但滤掉骨头。但是，如果我们想要的数据不容易与我们不想要的数据区分开来，会发生什么呢？

考虑一款有大量沉淀物的陈年佳酿。乍一看，我们可能看不到悬浮在液体中的沉淀物。但是当葡萄酒在醒酒器中放置一段时间后，沉淀物会沉到底部，我们就能倒出更整洁、更芳香的葡萄酒。在这种情况下，一个简单的过滤器是无法将葡萄酒和沉淀物分离的——需要一个特殊用途的工具。

在这一章中，我们将使用几个数据提取器来提取隐藏在难以理解的 PDF 文件中的所有有用的东西。我们将探讨以下主题:

*   PDF 文件有什么用，为什么很难从中提取数据
*   如何从 PDF 文件中复制和粘贴，以及当这不起作用时该怎么办
*   如何通过只保存我们需要的页面来缩小 PDF 文件
*   如何使用名为 **pdfMiner** 的 Python 包中的工具从 PDF 文件中提取文本和数字
*   如何使用名为 **Tabula** 的基于浏览器的 Java 应用程序从 PDF 文件中提取表格数据
*   如何使用 Adobe Acrobat 的完整付费版本提取数据表

# 为什么清理 PDF 文件很难？

以**可移植文档格式** ( **PDF** )保存的文件比我们在本书中到目前为止看到的文本文件稍微复杂一些。PDF 是由 Adobe Systems 发明的二进制格式，后来发展成为一种开放标准，以便多个应用程序可以创建其文档的 PDF 版本。PDF 文件的目的是提供一种方式来查看文档中的文本和图形，而不依赖于执行原始布局的软件。

在 20 世纪 90 年代早期，桌面出版的全盛时期，每个图形设计软件包都有不同的文件专用格式，而且这些软件包相当昂贵。那时候，为了查看用 Word、Pagemaker 或 Quark 创建的文档，你必须使用创建它的同一软件打开文档。这在 Web 的早期尤其成问题，因为在 HTML 中没有太多可用的技术来创建复杂的布局，但是人们仍然希望彼此共享文件。PDF 原本是一种厂商中立的布局格式。Adobe 将其 Acrobat Reader 软件免费提供给任何人下载，随后 PDF 格式被广泛使用。

### 注意

这里有一个关于 Acrobat Reader 早期的有趣事实。当把`click here`这几个字输入谷歌搜索引擎时，仍然会把 *Adobe 的 Acrobat PDF Reader 下载网站*作为第一个结果，而且已经这样做了很多年。这是因为许多网站在分发 PDF 文件时会附带一条信息，如“要查看此文件，您必须安装 Acrobat Reader。单击此处下载。”由于谷歌的搜索算法使用链接文本来了解什么网站配什么关键字，关键字 click here 现在与 Adobe Acrobat 的下载网站相关联。

PDF 仍然用于制作厂商和应用程序中立的文件版本，其布局比纯文本更复杂。例如，在不同版本的 Microsoft Word 中查看同一文档有时仍然会导致包含大量嵌入表格、样式、图像、表单和字体的文档看起来彼此不同。这可能是由多种因素造成的，例如操作系统的差异或所安装的 Word 软件本身的版本。即使应用程序旨在兼容不同的软件包或版本，细微的差异也会导致不兼容。PDF 的创建就是为了解决其中的一些问题。

我们马上可以看出，PDF 将比文本文件更难处理，因为它是二进制格式，并且因为它嵌入了字体、图像等等。因此，我们可信赖的数据清理工具箱中的大多数工具，如文本编辑器和命令行工具(`less`)在很大程度上对 PDF 文件没有用。幸运的是，我们仍然可以使用一些技巧从 PDF 文件中获取数据。



# 首先尝试简单的解决方案——复制

假设在你去倒一瓶上等红酒的路上，你把瓶子洒在了地板上。你的第一个想法可能是，这是一个彻底的灾难，你将不得不更换整个地毯。但是在你开始撕毁整层地板之前，可能有必要尝试用一个古老的调酒师的技巧来清理一下:苏打水和湿布。在这一节中，我们概述了在参与昂贵的文件更新项目之前首先要做的几件事。它们可能不起作用，但值得一试。

## 我们的实验文件

让我们通过使用一个真实的 PDF 文件来练习清理 PDF 数据。我们也不希望这个实验太简单，所以让我们选择一个非常复杂的文件。假设我们有兴趣从皮尤研究中心网站上的一个名为“大学值得吗？”的文件中提取数据。这份 PDF 文件于 2011 年发布，长达 159 页，包含大量数据表，显示了衡量在美国获得大学教育是否值得投资的各种方法。我们希望找到一种方法来快速提取这些大量表中的数据，以便我们可以对其运行一些额外的统计数据。例如，报告中的一个表如下所示:

![Our experimental file](graphics/4276OT_06_01.jpg)

这张桌子相当复杂。它只有六列八行，但是有几行占了两行，标题行文本只显示在五列上。

### Tip

完整的报告可以在 PewResearch 网站上找到，网址为[http://www . pewssocial trends . org/2011/05/15/is-college-worth-it/](http://www.pewsocialtrends.org/2011/05/15/is-college-worth-it/)，我们正在使用的特定文件被标记为完整报告:[http://www . pewssocial trends . org/files/2011/05/higher-ed-Report . pdf](http://www.pewsocialtrends.org/files/2011/05/higher-ed-report.pdf)。

## 第一步——试着复制出我们想要的数据

我们将在本例中实验的数据位于 PDF 文件的第 149 页(在他们的文档中标为第 143 页)。如果我们在 PDF 查看器中打开文件，例如在 Mac OSX 上预览，并试图只选择表格中的数据，我们已经看到一些奇怪的事情正在发生。例如，即使我们无意选择页码(143)；反正被选中了。这对我们的实验不是好兆头，但让我们继续。使用 Command-C 将数据复制出来，或者选择**编辑** | **复制**。

![Step one – try copying out the data we want](graphics/4276OT_06_02.jpg)

从预览中选择此 PDF 中的文本时的外观

## 第二步——尝试将复制的数据粘贴到文本编辑器中

下面的截图显示了复制的文本粘贴到我们的文本编辑器 Text Wrangler 时的样子:

![Step two – try pasting the copied data into a text editor](graphics/4276OT_06_03.jpg)

显然，这些数据在复制和粘贴后没有任何合理的顺序。包括页码，数字是水平的而不是垂直的，列标题是无序的。甚至有些数字已经合并；例如，最后一行包含数字 4，4，3，2；但是在粘贴的版本中，这变成了一个单独的数字 **4432** 。此时手动清理这些数据可能比重新键入原始表花费的时间更长。我们可以得出结论，对于这个特定的 PDF 文件，我们将不得不采取更强有力的措施来清理它。

### Tip

我们应该注意到，在这一点上，这个 PDF 文件的其他区域*做*清理得很好。例如，序言，一个位于文件第 3 页的纯文本部分，使用前面的技术就可以很好地复制出来。对于这个文件，只有实际的表格数据有问题。在决定提取技术之前，您应该试验 PDF 文件的所有部分，包括文本和表格数据。

## 第三步——制作一个更小的文件

我们的复制粘贴程序已经不起作用了，所以我们不得不接受这样一个事实:我们需要为更具侵入性的措施做准备。也许如果我们对从这个 PDF 文件的所有 159 页中提取数据不感兴趣，我们可以只确定我们想要操作的 PDF 区域，并将该部分保存到一个单独的文件中。

要在 MacOSX 上的**预览**中执行此操作，请启动**文件** | **打印…** 对话框。在**页面**区域，我们将输入我们实际想要复印的页面范围。为了这个实验的目的，我们只对第 149 页感兴趣；因此，在 **From:** 和 **to:** 框中输入`149`，如下图所示。

然后从底部的 **PDF** 下拉框中选择**在预览**中打开 PDF。您将在新窗口中看到您的单页 PDF。从这里，我们可以将它保存为一个新文件，并给它起一个新名字，比如`report149.pdf`或类似的名字。

![Step three – make a smaller version of the file](graphics/4276OT_06_04.jpg)

# 另一种可以尝试的技术——pdf miner

现在我们有了一个更小的文件来试验，让我们尝试一些程序性的解决方案来提取文本，看看我们是否进展得更好。pdfMiner 是一个 Python 包，带有两个嵌入式工具来操作 PDF 文件。我们特别感兴趣的是尝试其中的一个工具，一个名为`pdf2txt`的命令行程序，用于从 PDF 文档中提取文本。也许这能帮助我们正确地从文件中取出那些数字表。

## 第一步–安装 pdfMiner

启动 Canopy Python 环境。从 Canopy 终端窗口中，运行以下命令:

```
pip install pdfminer

```

这将安装整个 pdfMiner 包及其所有相关的命令行工具。

### Tip

pdfMiner 的文档及其附带的两个工具`pdf2txt`和`dumpPDF`位于 http://www.unixuser.org/~euske/python/pdfminer/的[中。](http://www.unixuser.org/~euske/python/pdfminer/)

## 第二步——从 PDF 文件中提取文本

我们可以使用名为`pdf2txt.py`的命令行工具从 PDF 文件中提取所有文本。为此，使用 Canopy 终端并导航到文件所在的目录。命令的基本格式是`pdf2txt.py <filename>`。如果您有一个包含多个页面的较大文件(或者您还没有将 PDF 分成较小的页面)，您也可以运行`pdf2txt.py –p149 <filename>`来指定您只需要第 149 页。

就像前面的复制粘贴实验一样，我们将不仅在第 149 页的表格上，而且在第 3 页的前言中尝试这种技术。为了只提取第 3 页的文本，我们运行以下命令:

```
pdf2txt.py –p3 pewReport.pdf

```

运行该命令后，Pew Research report 的摘录序言出现在我们的命令行窗口中:

![Step two – pull text from the PDF file](graphics/4276OT_06_05.jpg)

为了将该文本保存到名为`pewPreface.txt`的文件中，我们可以简单地添加一个重定向到我们的命令行，如下所示:

```
pdf2txt.py –p3 pewReport.pdf > pewPreface.txt

```

但是位于第 149 页的那些麻烦的数据表呢？当我们在上面使用`pdf2txt`时会发生什么？我们可以运行以下命令:

```
pdf2txt.py pewReport149.pdf

```

结果比复制和粘贴略好，但差不了多少。实际的数据输出部分如下面的屏幕截图所示。列标题和数据混合在一起，不同列中的数据显示顺序不同。

![Step two – pull text from the PDF file](graphics/4276OT_06_06.jpg)

我们将不得不宣布这个实验的表格数据提取部分失败，尽管 pdfMiner 在逐行文本提取方面工作得相当好。

### 注意

请记住，您使用这些工具的成功可能会有所不同。这在很大程度上取决于原始 PDF 文件的特定特征。

看起来我们为这个例子选择了一个非常棘手的 PDF，但是我们不要灰心丧气。相反，我们将转向另一个工具，看看我们的进展如何。



# 第三选择——白板

**Tabula** 是一个基于 Java 的程序，用于提取 PDF 文件中表格内的数据。我们将下载 Tabula 软件，并把它用于我们 149 页文件中的棘手表格。

## 第一步——下载白板

Tabula 可以从其位于[http://tabula.technology/](http://tabula.technology/)的网站上下载。该网站包括一些简单的下载说明。

### Tip

在 Mac OSX 版本 10.10.1 上，我必须先下载传统的 Java 6 应用程序，然后才能运行 Tabula。这个过程很简单，只需要按照屏幕上的指示操作。

## 第二步——白板演示

从下载的`.zip`档案中启动 Tabula。在 Mac 上，Tabula 应用程序文件简称为`Tabula.app`。如果你愿意，你可以把这个拷贝到你的`Applications`文件夹里。

当 Tabula 启动时，它会在您的默认网络浏览器中的地址`http://127.0.0.1:8080/`处启动一个标签或窗口。屏幕的初始操作部分如下所示:

![Step two – run Tabula](graphics/4276OT_06_07.jpg)

自动检测表格需要很长时间的警告是正确的。对于单页`perResearch149.pdf`文件，其中有三个表格，表格自动检测花了整整两分钟，并产生一条关于格式不正确的 PDF 文件的错误消息。

## 第三步——指导 Tabula 提取数据

一旦 Tabula 读入文件，就该把它指向表格所在的位置了。使用鼠标光标，选择您感兴趣的表。我在第一张桌子周围画了一个方框。

Tabula 用了大约 30 秒的时间读入表格，结果如下所示:

![Step three – direct Tabula to extract the data](graphics/4276OT_06_09.jpg)

与使用复制粘贴和`pdf2txt`读取数据的方式相比，这些数据看起来很棒。但是，如果您对 Tabula 读取表格的方式不满意，您可以通过清除您的选择并重新绘制矩形来重复此过程。

## 第四步——将数据复制出来

我们可以使用 Tabula 中的**下载数据**按钮将数据保存为更友好的文件格式，如 CSV 或 TSV。正如我们在前几章的工作中所知道的，如果有必要，这些格式可以在电子表格或文本编辑器中进行清理。恰在此时，我们准备好了下一步。

## 第五步——进一步清洁

在 Excel 或文本编辑器中打开 CSV 文件并查看。在这个阶段，我们在提取这个 PDF 数据时遇到了很多失败，所以现在退出是非常有诱惑力的。然而，如果您在一本关于数据清理的书中已经做到了这一步，您可能会猜测这些数据可以变得更整洁。下面是一些简单的数据清理任务，我们在前面的章节中已经知道如何去做:

1.  我们可以将所有的两行文本单元格合并成一个单元格。例如，在列 **B** 中，许多短语占据了不止一行。**让学生做好准备**和**劳动力的成员**应该作为一个短语出现在一个单元格中。第 **1** 和第 **2** 行的表头也是如此( **4 年**和**私有**应该在一个单元格内)。要在 Excel 中清除这种情况，请在列 **B** 和 **C** 之间创建一个新列。使用`concatenate()`函数加入 B3:B4，B5:B6，等等。使用**选择性粘贴**将新的连接值添加到新列中。然后删除不再需要的两列。对第 **1** 排和第 **2** 排进行同样的操作。
2.  Remove blank lines between rows.

    完成这些过程后，数据如下所示:

    ![Step five – more cleaning](graphics/4276OT_06_10.jpg)

### Tip

与剪切和粘贴数据或运行简单的命令行工具相比，Tabula 可能看起来工作量很大。这是真的，除非你的 PDF 文件像这个一样挑剔。记住专业工具的存在是有原因的——但是除非你真的需要，否则不要使用它们。首先从一个简单的解决方案开始，只有在你真正需要的时候才使用更难的工具。



# 当其他方法都失败时——第四个技巧

Adobe Systems 出售其 Acrobat 软件的付费商业版本，除了允许您阅读 PDF 文件之外，该软件还具有一些附加功能。使用完整版的 Acrobat，您可以创建复杂的 PDF 文件，并以各种方式操作现有文件。与此相关的功能之一是 Acrobat 中的**将选区导出为……**选项。

要开始使用此功能，请启动 Acrobat 并使用**文件打开**对话框打开 PDF 文件。在文件中，导航到包含要导出的数据的表格。下面的截图显示了如何从我们正在操作的 149 页 PDF 中选择数据。用鼠标选择数据，然后点击右键并选择**导出选择为…**

![When all else fails – the fourth technique](graphics/4276OT_06_11.jpg)

此时，Acrobat 将询问您希望如何导出数据。CSV 是选择之一。如果您确定不希望在文本编辑器中编辑文件，Excel 工作簿(`.xlsx`)也是一个不错的选择。因为我知道 Excel 也可以打开 CSV 文件，所以我决定以这种格式保存我的文件，这样我就可以在 Excel 和我的文本编辑器之间进行最灵活的编辑。

![When all else fails – the fourth technique](graphics/4276OT_06_12.jpg)

选择文件格式后，系统会提示我们输入文件名和保存文件的位置。当我们在文本编辑器或 Excel 中启动结果文件时，我们可以看到它看起来很像我们在上一节中看到的白板版本。下面是我们的 CSV 文件在 Excel 中打开时的样子:

![When all else fails – the fourth technique](graphics/4276OT_06_13.jpg)

此时，我们可以使用与 Tabula 数据完全相同的清理例程，将 B2:B3 单元格连接成一个单元格，然后删除空行。



# 总结

本章的目标是学习如何从 PDF 文件中导出数据。就像美酒中的沉淀物一样，PDF 文件中的数据初看起来很难分离。然而，不像倒酒，这是一个非常被动的过程，分离 PDF 数据需要大量的试验和错误。我们学习了使用 PDF 文件清理数据的四种方法:复制和粘贴、pdfMiner、Tabula 和 Acrobat 导出。这些工具各有优缺点:

*   复制和粘贴不需要任何成本，只需要很少的工作，但是对于复杂的表格来说就不那么有效了。
*   pdfMiner/Pdf2txt 也是免费的，作为命令行工具，它可以自动化。它还可以处理大量数据。但是和复制粘贴一样，很容易被某些类型的表格混淆。
*   Tabula 需要一些工作来设置，因为它是一个正在开发的产品，它偶尔会发出奇怪的警告。它也比其他选项稍慢。然而，它的输出非常整洁，即使是复杂的表。
*   Acrobat 给出了与 Tabula 相似的输出，但是几乎不需要设置，也很容易。是付费产品。

最后，我们有了一个整洁的数据集，可以进行分析或长期存储。

在下一章中，我们将把重点放在长期存储在关系数据库管理系统 ( **RDBMS** )中的数据。我们将了解清理以这种方式存储的数据的挑战，以及一些常见的数据异常和如何修复它们。