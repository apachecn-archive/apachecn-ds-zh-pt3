<html lang="en">
<head><title>Automating the Machine Learning Process with H2O</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>
<body>
 
<!--Begin Abstract--><h1 class="ChapterTitle" lang="en">10.用 H2O 自动化机器学习过程</h1>

 
<!--End Abstract--><p class="Para" id="Par2">这是一个简短但有见地的章节，通过解释一种直接的方法来自动化机器学习过程，并借助一个广泛的机器学习框架，即 H2O，来结束这本书。</p>
<h2 class="Heading">探索自动化机器学习</h2>
<p class="Para" id="Par3">在一个充斥着无数机器学习框架的世界里，你可能会认为组织会很容易地采用机器学习。不幸的是，情况并非如此。由于机器算法相当复杂，技能严重短缺。</p>
<p class="Para" id="Par4">为了应对这些挑战，H2O 推出了 AutoML，试图通过同时训练和精选具有非凡性能的方法来自动化机器学习过程。</p>
<p class="Para" id="Par5">虽然 H2O AutoML 功能是有益的，但它不包括聚类分析、生存分析和时间序列分析等方法。</p>
<p class="Para" id="Par6">本章使用第<a href="03.html"> 3 章</a>中的数据。它还区分了领先的 AutoML 方法与第<a href="03.html"> 3 </a>章中执行的方法的性能。</p>

<h2 class="Heading">预处理特征</h2>
<p>本章操作在第<a href="03.html"> 3 </a>章中获得的数据，因此不详细描述预处理任务。清单<a href="#PC1"> 10-1 </a>执行所有的预处理任务。</p>
<pre>import pandas as pd
df = pd.read_csv(r"filepath\WA_Fn-UseC_-Marketing_Customer_Value_Analysis.csv")
drop_column_names = df.columns[[0, 6]]
initial_data = df.drop(drop_column_names, axis="columns")
initial_data.iloc[::, 0] = pd.get_dummies(initial_data.iloc[::, 0])
initial_data.iloc[::, 2] = pd.get_dummies(initial_data.iloc[::, 2])
initial_data.iloc[::, 3] = pd.get_dummies(initial_data.iloc[::, 3])
initial_data.iloc[::, 4] = pd.get_dummies(initial_data.iloc[::, 4])
initial_data.iloc[::, 5] = pd.get_dummies(initial_data.iloc[::, 5])
initial_data.iloc[::, 6] = pd.get_dummies(initial_data.iloc[::, 6])
initial_data.iloc[::, 7] = pd.get_dummies(initial_data.iloc[::, 7])
initial_data.iloc[::, 8] = pd.get_dummies(initial_data.iloc[::, 8])
initial_data.iloc[::, 9] = pd.get_dummies(initial_data.iloc[::, 9])
initial_data.iloc[::, 15] = pd.get_dummies(initial_data.iloc[::, 15])
initial_data.iloc[::, 16] = pd.get_dummies(initial_data.iloc[::, 16])
initial_data.iloc[::, 17] = pd.get_dummies(initial_data.iloc[::, 17])
initial_data.iloc[::, 18] = pd.get_dummies(initial_data.iloc[::, 18])
initial_data.iloc[::, 20] = pd.get_dummies(initial_data.iloc[::, 20])
initial_data.iloc[::, 21] = pd.get_dummies(initial_data.iloc[::, 21])

Listing 10-1Preprocess Features


</pre>
<h3 class="Heading">H2O 自动步枪在行动中</h3>
<p class="Para" id="Par8">本节使用<code>H2OAutoML()</code>方法训练多种方法，并对其性能进行排名。该部门执行并评估<code>H2OAutoML</code>。</p>
<p>清单<a href="#PC2"> 10-2 </a>准备 H2O 框架。</p>
<pre>import h2o as initialize_h2o
initialize_h2o.init()

Listing 10-2Prepare the H2O Framework


</pre>
<p>清单<a href="#PC3"> 10-3 </a>将<code>pandas</code>数据帧更改为 H2O 数据帧。</p>
<pre>h2o_data = initialize_h2o.H2OFrame(initial_data)

Listing 10-3Change the Pandas Dataframe to H2O Dataframe


</pre>
<p>清单<a href="#PC4"> 10-4 </a>概述了独立和从属特征。</p>
<pre>int_x = initial_data.iloc[::,0:19]
fin_x = initial_data.iloc[::,19:21]
x_combined = pd.concat([int_x, fin_x], axis=1)
x_list = list(x_combined.columns)
y_list = initial_data.columns[19]
y = y_list
x = h2o_data.col_names
x.remove(y_list)

Listing 10-4Outline the Features


</pre>
<p>清单<a href="#PC5"> 10-5 </a>随机划分数据。</p>
<pre>h2o_training_data, h2o_validation_data, h2o_test_data = h2o_data.split_frame(ratios=[.8,.1])
The H2OAutoML() method enables us to stipulate the considerable time needed to train each method. Specify max_runtime_secs to do so.

Listing 10-5Randomly Divide the Dataframe


</pre>
<p>清单<a href="#PC6"> 10-6 </a>执行 H2O 的自动机器学习方法。</p>
<pre>from h2o.automl import H2OAutoML
h2o_automatic_ml = H2OAutoML(max_runtime_secs = 240)
h2o_automatic_ml.train(x= x, y= y, training_frame = h2o_training_data, validation_frame = h2o_validation_data)

Listing 10-6Execute H2O’s Auto Machine Learning


</pre>
<p>清单<a href="#PC7"> 10-7 </a>按升序排列 H2O 的方法(见表<a href="#Tab1"> 10-1 </a>)。</p>
<p>表 10-1</p><p class="SimplePara">H2O 方法排名</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
<col class="tcol4 align-left"/>
<col class="tcol5 align-left"/>
<col class="tcol6 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">型号 ID</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">均值 _ 残差 _ 偏差</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">均方根误差(root-mean-square error)</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">均方误差(mean square error)</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">平均绝对误差</p>
</th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Rmsle</p>
</th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>StackedEnsemble_AllModels_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Eighteen thousand three hundred and seventy-one point three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and thirty-five point five four one</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Eighteen thousand three hundred and seventy-one point three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">86.6257</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.482043</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>StackedEnsemble_BestOfFamily_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Eighteen thousand five hundred and sixty-six point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and thirty-six point two six</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Eighteen thousand five hundred and sixty-six point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">87.7959</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.477828</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_1_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand three hundred and ninety-two point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and thirty-nine point two five eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand three hundred and ninety-two point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">90.0652</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.490441</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_3_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand three hundred and ninety-seven point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and thirty-nine point two seven six</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand three hundred and ninety-seven point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">90.3467</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.490855</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_2_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand four hundred and sixty-seven point three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and thirty-nine point five two five</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand four hundred and sixty-seven point three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">89.9908</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.491887</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_grid__1_AutoML_20210824_115721_model_4</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand six hundred and seven point nine</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and forty point zero two eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand six hundred and seven point nine</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">91.3311</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.495784</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_4_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand six hundred and thirty-three point four</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and forty point one one nine</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand six hundred and thirty-three point four</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">89.9553</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.499693</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>XRT_1_AutoML_20210824_115721</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand seven hundred and seventeen point six</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and forty point four two</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand seven hundred and seventeen point six</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">89.7474</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.485144</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_grid__1_AutoML_20210824_115721_model_2</code></p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand eight hundred and five point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and forty point seven three three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand eight hundred and five point eight</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">91.7092</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.494005</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara"><code>GBM_grid__1_AutoML_20210824_115721_model_9</code></p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand eight hundred and fifty-eight point six</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">One hundred and forty point nine two one</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Nineteen thousand eight hundred and fifty-eight point six</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">90.0839</p>
</td>
<td style="text-align: left;"><p class="SimplePara">0.521174</p>
</td>
</tr>
</tbody>
</table>

<pre>h2o_method_ranking = h2o_automatic_ml.leaderboard
print(h2o_method_ranking)

Listing 10-7Rank H2O’s Methods


</pre>
<p class="Para" id="Par15">表<a href="#Tab1"> 10-1 </a>表明<code>StackedEnsemble_AllModels_AutoML_20210824_115721</code>是排名最高的方法，具有最小的均方根残差偏差(在 18371.3)。均方根误差为 135.541。</p>
<p>相比之下，排名最低的方法是<code>GBM_grid__1_AutoML_20210824_115721_</code> model_9，平均残差偏差为 19858.6，均方根误差为 140.921。清单<a href="#PC8"> 10-8 </a>评估最高排名法(<code>StackedEnsemble_AllModels_AutoML_20210824_115721</code>)。</p>
<pre>highest_ranking_method = h2o_automatic_ml.leader
print(highest_ranking_method)

ModelMetricsRegressionGLM: stackedensemble
** Reported on train data. **

MSE: 4900.131929292816
RMSE: 70.00094234574857
MAE: 45.791336342731775
RMSLE: 0.3107457400431741
R^2: 0.9421217261180531
Mean Residual Deviance: 4900.131929292816
Null degrees of freedom: 7288
Residual degrees of freedom: 7276
Null deviance: 617106545.1167994
Residual deviance: 35717061.632615335
AIC: 82648.0458245655

ModelMetricsRegressionGLM: stackedensemble
** Reported on validation data. **

MSE: 17967.946605287365
RMSE: 134.04456947331872
MAE: 83.66742154264892
RMSLE: 0.43883929226519075
R^2: 0.7718029372846945
Mean Residual Deviance: 17967.946605287365
Null degrees of freedom: 930
Residual degrees of freedom: 918
Null deviance: 73564698.35450743
Residual deviance: 16728158.289522538
AIC: 11790.460469478105

ModelMetricsRegressionGLM: stackedensemble
** Reported on cross-validation data. **

MSE: 18371.339394332357
RMSE: 135.5409140973026
MAE: 86.62574587341507
RMSLE: 0.4820432203973515
R^2: 0.7830055540572105
Mean Residual Deviance: 18371.339394332357
Null degrees of freedom: 7288
Residual degrees of freedom: 7275
Null deviance: 617269595.4214188
Residual deviance: 133908692.84528854
AIC: 92282.67565857261

Listing 10-8Execute H2O Auto Machine Learning


</pre>
<p class="Para" id="Par17">结果表明<code>StackedEnsemble_AllModels_AutoML_20210824_115721</code>方法解释了测试数据中 77%的相关变化和验证中 78%的相关变化。</p>


<h2 class="Heading">结论</h2>
<p class="Para" id="Par18">排名最高的 H2O 自动方法(<code>StackedEnsemble_AllModels_AutoML_20210824_115721</code>)与本章中执行的普通最小二乘法相比相形见绌。H2O 方法揭示了试验数据中 77%的相关变化。相比之下，第 3 章<a href="03.html">中执行的所有方法(使用 Scikit-Learn 和 PySpark 框架)解释了测试数据中 100%的相关变化。不幸的是，<code>StackedEnsemble_AllModels_AutoML_20210824_115721</code>方法没有汇总功能。这本书到此结束。</a></p>



</body>
</html>