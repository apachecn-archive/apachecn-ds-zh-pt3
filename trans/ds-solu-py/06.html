<html lang="en">
<head><title>Tree Modeling and Gradient Boosting with Scikit-Learn, XGBoost, PySpark, and H2O</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>
<body>
 
<!--Begin Abstract--><h1 class="ChapterTitle" lang="en">6.使用 Scikit-Learn、XGBoost、PySpark 和 H2O 进行树建模和梯度增强</h1>

 
<!--End Abstract--><p class="Para" id="Par2">本章使用一组不同的综合 Python 框架(即 Scikit-Learn、XGBoost、PySpark 和 H2O)来执行和评估基于树的方法(决策树方法)和集成方法(梯度推进树方法)。首先，本章阐明了决策树如何计算类的概率。</p>
<h2 class="Heading">决策树</h2>
<p><em class="EmphasisTypeItalic ">决策树</em>是一种基本的非参数方法，适用于线性和非线性建模。它执行决策规则并开发一个树状结构，该结构以最小的深度将值分成不同的组(见图<a href="#Fig1"> 6-1 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig1_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig1_HTML.jpg" style="width:37.5em"/></p>
<p>图 6-1</p><p class="SimplePara">决策图表</p>



<h2 class="Heading">预处理特征</h2>
<p>本章处理第<a href="05.html">章到第</a>章的数据，因此它没有依次涵盖预处理任务。清单<a href="#PC1"> 6-1 </a>执行所有的预处理任务。</p>
<pre>from sklearn.tree import DecisionTreeClassifier
import numpy as np
import pandas as pd
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split
df = pd.read_csv(r"filepath\banking.csv")
drop_column_names = df.columns[[8, 9, 10]]
initial_data = df.drop(drop_column_names, axis="columns")
initial_data.iloc[::, 1] = pd.get_dummies(initial_data.iloc[::, 1])
initial_data.iloc[::, 2] = pd.get_dummies(initial_data.iloc[::, 2])
initial_data.iloc[::, 3] = pd.get_dummies(initial_data.iloc[::, 3])
initial_data.iloc[::, 4] = pd.get_dummies(initial_data.iloc[::, 4])
initial_data.iloc[::, 5] = pd.get_dummies(initial_data.iloc[::, 5])
initial_data.iloc[::, 6] = pd.get_dummies(initial_data.iloc[::, 6])
initial_data.iloc[::, 7] = pd.get_dummies(initial_data.iloc[::, 7])
initial_data.iloc[::, 11] = pd.get_dummies(initial_data.iloc[::, 11])
initial_data = initial_data.dropna()
x = np.array(initial_data.iloc[::, 0:17])
y = np.array(initial_data.iloc[::, -1])
x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2, random_state=0)
sk_standard_scaler = StandardScaler()
sk_standard_scaled_x_train = sk_standard_scaler.fit_transform(x_train)
sk_standard_scaled_x_test = sk_standard_scaler.transform(x_test)

Listing 6-1Preprocess Features


</pre>
<h3 class="Heading">sci kit-在行动中学习</h3>
<p>本节使用 Scikit-Learn 框架执行和评估决策树方法。清单<a href="#PC2"> 6-2 </a>用 Scikit-Learn 框架执行决策树方法。</p>
<pre>from sklearn.tree import DecisionTreeClassifier
sk_decision_tree_method = DecisionTreeClassifier()
sk_decision_tree_method.fit(sk_standard_scaled_x_train, y_train)

Listing 6-2Execute the Scikit-Learn Decision Tree Method


</pre>
<p>清单<a href="#PC3"> 6-3 </a>确定了 Scikit-Learn 决策树方法的最佳超参数。</p>
<pre>from sklearn.model_selection import GridSearchCV
sk_decision_tree_method_parameters = {"criterion":("gini","entropy"), "max_depth":[1, 2, 3, 4, 5, 6]}
sk_decision_tree_method_g_search = GridSearchCV(estimator = sk_decision_tree_method, param_grid = sk_decision_tree_method_parameters)
sk_decision_tree_method_g_search.fit(sk_standard_scaled_x_train, y_train)
print("Best decision tree regression score: ", sk_decision_tree_method_g_search.best_score_)
print("Best decision tree parameter: ", sk_decision_tree_method_g_search.best_params_)

Best decision tree regression score:  0.900030349013657
Best decision tree parameter:  {'criterion': 'entropy', 'max_depth': 5}

Listing 6-3Determine the Best Hyperparameters for the Scikit-Learn Decision Tree Method


</pre>
<p>清单<a href="#PC4"> 6-4 </a>使用 Scikit-Learn 框架执行决策树方法。</p>
<pre>sk_decision_tree_method = DecisionTreeClassifier(criterion = "entropy", max_depth = 5)
sk_decision_tree_method.fit(sk_standard_scaled_x_train, y_train)

Listing 6-4Execute the Scikit-Learn Decision Tree Method


</pre>
<p>清单<a href="#PC5"> 6-5 </a>排列 Scikit-Learn 决策树方法的分类报告(见表<a href="#Tab1"> 6-1 </a>)。</p>
<p>表 6-1</p><p class="SimplePara">Scikit-Learn 决策树方法的分类报告</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
<col class="tcol4 align-left"/>
<col class="tcol5 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">精确</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">回忆</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">f1-分数</p>
</th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">支持</p>
</th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Zero</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.914696</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.982253</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.947271</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">7325.000000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">one</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.650538</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.265060</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.376654</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">913.000000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">准确</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.902768</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.902768</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.902768</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.902768</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Avg 宏</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.782617</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.623656</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.661963</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">8238.000000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">加权平均值</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.885420</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.902768</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.884031</p>
</td>
<td style="text-align: left;"><p class="SimplePara">8238.000000</p>
</td>
</tr>
</tbody>
</table>

<pre>from sklearn import metrics
sk_yhat = sk_decision_tree_method.predict(sk_standard_scaled_x_test)
sk_decision_tree_method_assessment_2 = pd.DataFrame(metrics.classification_report(y_test, sk_yhat, output_dict=True)).transpose()
sk_decision_tree_method_assessment_2

Listing 6-5Arrange the Scikit-Learn Decision Tree Method’s Classification Report


</pre>
<p>列表<a href="#PC6"> 6-6 </a>排列决策树方法的接收机工作特性曲线，浓缩真阳性率和假阳性率的排列(见图<a href="#Fig2"> 6-2 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig2_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig2_HTML.jpg" style="width:40.68em"/></p>
<p>图 6-2</p><p class="SimplePara">Scikit-Learn 决策的接收器工作特性曲线</p>


<pre>import matplotlib.pyplot as plt
%matplotlib inline
sk_yhat_proba = sk_decision_tree_method.predict_proba(sk_standard_scaled_x_test)[::,1]
fpr_sk_decision_tree_method, tprr_sk_decision_tree_method, _ = metrics.roc_curve(y_test, sk_yhat_proba)
area_under_curve_sk_decision_tree_method = metrics.roc_auc_score(y_test, sk_yhat_proba)
plt.plot(fpr_sk_decision_tree_method, tprr_sk_decision_tree_method, label="AUC= "+ str(area_under_curve_sk_decision_tree_method))
plt.xlabel("False Positive Rate (FPR)")
plt.ylabel("True Positive Rate (TPR)")
plt.legend(loc="best")
plt.show()

Listing 6-6Receiver Operating Characteristics Curve for the Decision Tree Method (Executed by the Scikit-Learn Framework)


</pre>
<p>列表<a href="#PC7"> 6-7 </a>排列 Scikit-Learn 决策树方法的接收器操作特性曲线，以浓缩精度和召回率的排列(见图<a href="#Fig3"> 6-3 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig3_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig3_HTML.jpg" style="width:42.82em"/></p>
<p>图 6-3</p><p class="SimplePara">Scikit-Learn 框架决策树方法的精确召回曲线</p>


<pre>p_sk_decision_tree_method, r__sk_decision_tree_method, _ = metrics.precision_recall_curve(y_test, sk_yhat)
weighted_ps_sk_decision_tree_method = metrics.roc_auc_score(y_test, sk_yhat)
plt.plot(p_sk_decision_tree_method, r__sk_decision_tree_method,
         label="WPR= " +str(weighted_ps_sk_decision_tree_method))
plt.xlabel("Recall")
plt.ylabel("Precision")
plt.legend(loc="best")
plt.show()

Listing 6-7Precision-Recall Curve for the Scikit-Learn Decision Tree Method


</pre>
<p>清单<a href="#PC8"> 6-8 </a>排列了 Scikit-Learn 决策树方法的学习曲线(见图<a href="#Fig4"> 6-4 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig4_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig4_HTML.jpg" style="width:42.82em"/></p>
<p>图 6-4</p><p class="SimplePara">Scikit-Learn 执行的决策树方法的学习曲线</p>


<pre>from sklearn.model_selection import learning_curve
train_port_sk_decision_tree_method, trainscore_sk_decision_tree_method, testscore_sk_decision_tree_method = learning_curve(sk_decision_tree_method, x, y,
 cv=3, n_jobs=-5, train_sizes=np.linspace(0.1,1.0,50))
trainscoresk_decision_tree_method_mean = np.mean(trainscore_sk_decision_tree_method, axis=1)
testscoresk_decision_tree_method_mean = np.mean(testscore_sk_decision_tree_method, axis=1)
plt.plot(train_port_sk_decision_tree_method, trainscoresk_decision_tree_method_mean, label="Weighted training accuracy")
plt.plot(train_port_sk_decision_tree_method, testscoresk_decision_tree_method_mean, label="Weighted cv accuracy Score")
plt.xlabel("Training values")
plt.ylabel("Weighted accuracy score")
plt.legend(loc="best")
plt.show()

Listing 6-8Learning Curve for the Decision Tree Method Executed by the Scikit-Learn Framework


</pre>


<h2 class="Heading">梯度推进</h2>
<p class="Para" id="Par12">梯度增强方法继承输入要素的值，然后执行无数的树模型来停止损失函数(即，线性建模的平均绝对误差)。它通过吸收弱模型来做到这一点，然后增量和迭代地对加权数据建模，努力地选择具有最佳性能的弱模型。</p>
<h3 class="Heading">XGBoost 正在运行</h3>
<p>本节使用 XGBoost 框架执行和评估决策树方法。清单<a href="#PC9"> 6-9 </a>执行 XGBoost 梯度增强方法。</p>
<pre>from xgboost import XGBClassifier
xgb_gradient_boosting_method = XGBClassifier()
xgb_gradient_boosting_method.fit(sk_standard_scaled_x_train, y_train)

Listing 6-9Execute the XGBoost Gradient Boosting Method


</pre>
<p>清单<a href="#PC10"> 6-10 </a>整理 XGBoost 梯度提升方法的分类报告(见表<a href="#Tab2"> 6-2 </a>)。</p>
<p>表 6-2</p><p class="SimplePara">XGBoost 梯度推进法的分类报告</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
<col class="tcol4 align-left"/>
<col class="tcol5 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">精确</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">回忆</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">f1-分数</p>
</th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">支持</p>
</th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Zero</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.913410</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.976382</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.943847</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">7325.00000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">one</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.575980</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.257393</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.355791</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">913.000000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">准确</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.896698</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.896698</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.896698</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.896698</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Avg 宏</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.744695</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.616888</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.649819</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">8238.000000</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">加权平均值</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.876013</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.896698</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.878674</p>
</td>
<td style="text-align: left;"><p class="SimplePara">8238.000000</p>
</td>
</tr>
</tbody>
</table>

<pre>sk_yhat_xgb_gradient_boosting_method = sk_yhat_xgb_gradient_boosting_method = xgb_gradient_boosting_method.predict(sk_standard_scaled_x_test)
xgb_gradient_boosting_method_assessment_2 = pd.DataFrame(metrics.classification_report(y_test, sk_yhat_xgb_gradient_boosting_method, output_dict=True)).transpose()
print(xgb_gradient_boosting_method_assessment_2)

Listing 6-10Arrange the XGBoost Gradient Boosting Method’s Classification Report


</pre>
<p>清单<a href="#PC11"> 6-11 </a>整理了 XGBoost 梯度增强法的接收机工作特性曲线，浓缩了精度和召回率的安排(见图<a href="#Fig5"> 6-5 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig5_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig5_HTML.jpg" style="width:42.82em"/></p>
<p>图 6-5</p><p class="SimplePara">XGBoost 梯度增强方法的接收器工作特性曲线</p>


<pre>yhat_proba_xgb_gradient_boosting_method = xgb_gradient_boosting_method.predict_proba(sk_standard_scaled_x_test)[::,1]
fpr_xgb_gradient_boosting_method, tprr_xgb_gradient_boosting_method, _ = metrics.roc_curve(y_test, yhat_proba_xgb_gradient_boosting_method)
area_under_curve_xgb_gradient_boosting_method = metrics.roc_auc_score(y_test, yhat_proba_xgb_gradient_boosting_method)
plt.plot(fpr_xgb_gradient_boosting_method, tprr_xgb_gradient_boosting_method, label="AUC= "+ str(area_under_curve_xgb_gradient_boosting_method))
plt.xlabel("False Positive Rate (FPR)")
plt.ylabel("True Positive Rate (TPR)")
plt.legend(loc="best")
plt.show()

Listing 6-11Receiver Operating Characteristics Curve for the XGBoost Gradient Boosting Method


</pre>
<p>清单<a href="#PC12"> 6-12 </a>排列了 XGBoost 梯度提升方法的精度-召回曲线，浓缩了精度和召回的排列(见图<a href="#Fig6"> 6-6 </a>)。</p>
<p><img alt="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig6_HTML.jpg" src="../images/517508_1_En_6_Chapter/517508_1_En_6_Fig6_HTML.jpg" style="width:42.82em"/></p>
<p>图 6-6</p><p class="SimplePara">Scikit-Learn 决策树方法的精确召回曲线</p>


<pre>sk_yhat_xgb_gradient_boosting_method)
weighted_ps_xgb_gradient_boosting_method = metrics.roc_auc_score(y_test, sk_yhat_xgb_gradient_boosting_method)
plt.plot(p_xgb_gradient_boosting_method, r__xgb_gradient_boosting_method,
         label="WPR= " +str(weighted_ps_xgb_gradient_boosting_method))
plt.xlabel("Recall")
plt.ylabel("Precision")
plt.legend(loc="best")
plt.show()

Listing 6-12Precision-Recall Curve for the Scikit-Learn Decision Tree Method


</pre>

<h3 class="Heading">PySpark 在行动</h3>
<p>本节使用 PySpark 框架执行和评估梯度提升方法。清单<a href="#PC13"> 6-13 </a>使用<code>findspark</code>框架准备 PySpark 框架。</p>
<pre>import findspark as initiate_pyspark
initiate_pyspark.init("filepath\spark-3.0.0-bin-hadoop2.7")

Listing 6-13Prepare the PySpark Framework


</pre>
<p>清单<a href="#PC14"> 6-14 </a>使用<code>SparkConf()</code>方法规定了 PySpark 应用程序。</p>
<pre>from pyspark import SparkConf
pyspark_configuration = SparkConf().setAppName("gradient_boosting_method").setMaster("local")

Listing 6-14Stipulate the PySpark App


</pre>
<p>清单<a href="#PC15"> 6-15 </a>使用<code>SparkSession()</code>方法准备 PySpark 会话。</p>
<pre>from pyspark.sql import SparkSession
pyspark_session = SparkSession(pyspark_context)

Listing 6-15Prepare the Spark Session


</pre>
<p>清单<a href="#PC16"> 6-16 </a>使用<code>createDataFrame()</code>方法将本章前面创建的<code>pandas</code>数据帧更改为 PySpark 数据帧。</p>
<pre>pyspark_initial_data = pyspark_session.createDataFrame(initial_data)

Listing 6-16Change the Pandas Dataframe to a PySpark Dataframe


</pre>
<p>清单<a href="#PC17"> 6-17 </a>为独立特性创建一个列表，为从属特性创建一个字符串。然后，它使用<code>VectorAssembler()</code>方法转换数据，以便用 PySpark 框架建模。</p>
<pre>x_list = list(initial_data.iloc[::, 0:17].columns)
y_list = str(initial_data.columns[-1])
from pyspark.ml.feature import VectorAssembler
pyspark_data_columns = x_list
pyspark_vector_assembler = VectorAssembler(inputCols=pyspark_data_columns, outputCol="features")
pyspark_data = pyspark_vector_assembler.transform(pyspark_initial_data)

Listing 6-17Transform the Data


</pre>
<p>清单<a href="#PC18"> 6-18 </a>用<code>randomSplit()</code>方法划分数据。</p>
<pre>(pyspark_training_data, pyspark_test_data) = pyspark_data.randomSplit([.8,.2])

Listing 6-18Divide the Dataframe


</pre>
<p>清单<a href="#PC19"> 6-19 </a>执行 PySpark 梯度推进回归方法。</p>
<pre>from pyspark.ml.classification import GBTClassifier
pyspark_gradient_boosting_method = GBTClassifier(labelCol = y_list, featuresCol = "features")
pyspark_gradient_boosting_method_fitted = pyspark_gradient_boosting_method.fit(pyspark_training_data)

Listing 6-19Execute the PySpark Gradient Boosting Method


</pre>
<p>清单<a href="#PC20"> 6-20 </a>使用 PySpark 框架计算梯度推进回归方法的预测。</p>
<pre>pyspark_yhat = pyspark_gradient_boosting_method_fitted.transform(pyspark_test_data)

Listing 6-20Gradient Boosting Method Predictions (Method Executed with PySpark Framework)


</pre>

<h3 class="Heading">H2O 在行动</h3>
<p>这部分用 H2O 框架执行和评估主成分方法。清单<a href="#PC21"> 6-21 </a>准备 H2O 框架。</p>
<pre>import h2o as initialize_h2o
initialize_h2o.init()

Listing 6-21Prepare the H2O Framework


</pre>
<p>清单<a href="#PC22"> 6-22 </a>将<code>pandas</code>数据帧更改为 H2O 数据帧。</p>
<pre>h2o_data = initialize_h2o.H2OFrame(initial_data)

Listing 6-22Change the Pandas Dataframe to an H2O Dataframe


</pre>
<p>清单<a href="#PC23"> 6-23 </a>概述了这些特性。</p>
<pre>x_list = list(initial_data.iloc[::, 0:17].columns)
y_list = str(initial_data.columns[-1])
y = y_list
x = h2o_data.col_names
x.remove(y_list)

Listing 6-23Outline the Features


</pre>
<p>清单<a href="#PC24"> 6-24 </a>随机划分数据帧。</p>
<pre>h2o_training_data, h2o_validation_data, h2o_test_data = h2o_data.split_frame(ratios=[.8,.1])

Listing 6-24Randomly Divide the Dataframe


</pre>
<p>清单<a href="#PC25"> 6-25 </a>执行 H2O 梯度推进方法。</p>
<pre>from h2o.estimators import H2OGradientBoostingEstimator
h2o_gradient_boosting_method = H2OGradientBoostingEstimator(nfolds=3)
h2o_gradient_boosting_method.train(x = x, y = y, training_frame = h2o_training_data, validation_frame = h2o_validation_data)

Listing 6-25Execute the H2O Gradient Boosting Method


</pre>
<p>清单<a href="#PC26"> 6-26 </a>评估 H2O 梯度推进方法(见表<a href="#Tab3"> 6-3 </a>)。</p>
<p>表 6-3</p><p class="SimplePara">H2O 梯度推进法评估</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
<col class="tcol4 align-left"/>
<col class="tcol5 align-left"/>
<col class="tcol6 align-left"/>
<col class="tcol7 align-left"/>
<col class="tcol8 align-left"/>
<col class="tcol9 align-left"/>
<col class="tcol10 align-left"/>
<col class="tcol11 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">时间戳</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">持续时间</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">树的数量</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">培训 _rmse</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">培训 _mae</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">培训 _ 偏差</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">验证 _rmse</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">验证 _mae</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">验证 _ 偏差</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"> </th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Zero</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">2021-08-24 04:04:30</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">10.384 秒</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Zero</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.317003</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.200981</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.100491</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.311883</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.197762</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.097271</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">one</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">2021-08-24 04:04:30</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">10.496 秒</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.309924</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.196310</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.096053</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.305219</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.193472</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.093159</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Two</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">2021-08-24 04:04:30</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">10.586 秒</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Two</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.304085</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.192122</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.092468</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.299762</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.189611</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.089857</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">2021-08-24 04:04:30</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">10.659 秒</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Three</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.299238</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.188351</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.089543</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.295379</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.186199</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.087249</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">four</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">2021-08-24 04:04:30</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">10.745 秒</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Four</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.295198</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.184939</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.087142</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.291736</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.183116</p>
</td>
<td style="text-align: left;"><p class="SimplePara">0.085110</p>
</td>
</tr>
</tbody>
</table>

<pre>h2o_gradient_boosting_method_history = h2o_gradient_boosting_method.scoring_history()
print(h2o_gradient_boosting_method_history.head(5))

Listing 6-26Assess the H2O Gradient Boosting Method


</pre>


<h2 class="Heading">结论</h2>
<p class="Para" id="Par31">本章执行了四个关键的机器学习框架(Scikit-Learn、XGBoost、PySpark 和 H2O)来对数据进行建模，并使用决策树和梯度推进方法生成具有两个类的分类输出特征。</p>



</body>
</html>