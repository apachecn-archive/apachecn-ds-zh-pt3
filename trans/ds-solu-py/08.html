<html lang="en">
<head><title>Cluster Analysis with Scikit-Learn, PySpark, and H2O</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>
<body>
 
<!--Begin Abstract--><h1 class="ChapterTitle" lang="en">8.使用 Scikit-Learn、PySpark 和 H2O 进行聚类分析</h1>

 
<!--End Abstract--><p class="Para" id="Par2">本章通过实现一组不同的 Python 框架(即 Scikit-Learn、PySpark 和 H2O)来解释<em class="EmphasisTypeItalic "> k-means </em>聚类方法。首先，它阐明了该方法如何将值分配给聚类。</p>
<h2 class="Heading">探索 K 均值方法</h2>
<p class="Para" id="Par3">k-means 方法是最常用的距离计算方法。它是无监督机器学习家族的一部分。它使用欧几里德距离目标函数来有效地计算值之间的距离，然后确定中心并绘制与中心相邻的值来建立聚类。</p>
<p class="Para" id="Par4">与其他聚类方法(即空间聚类方法、birch 方法和凝聚方法)相比，此方法要求您在训练之前规定 k 的数量。本章使用揭示线性变化向量波动的<em class="EmphasisTypeItalic ">肘曲线</em> <em class="EmphasisTypeItalic ">、</em>来确定<em class="EmphasisTypeItalic "> k </em>的个数。本章执行该方法，根据具体特征(即年龄、报酬和消费习惯)对客户进行分组。</p>
<p>清单<a href="#PC1"> 8-1 </a>从微软 CSV 文件中获取必要的数据。</p>
<pre>import pandas as pd
df = pd.read_csv(r"filepath\Mall_Customers.csv")

Listing 8-1Attain the Data


</pre>
<p>清单<a href="#PC2"> 8-2 </a>删除了数据中不必要的特征。</p>
<pre>drop_column_names = df.columns[[0, 1]]
initial_data = df.drop(drop_column_names, axis="columns")

Listing 8-2Drop Unnecessary Features


</pre>
<p>清单<a href="#PC3"> 8-3 </a>用标准缩放器缩放数据。</p>
<pre>from sklearn.preprocessing import StandardScaler
sk_standard_scaler = StandardScaler()
sk_standard_scaled_data = sk_standard_scaler.fit_transform(initial_data)

Listing 8-3Scale the Data


</pre>
<p>清单<a href="#PC4"> 8-4 </a>使用 Scikit-Learn 框架执行主成分方法。</p>
<pre>from sklearn.decomposition import PCA
sk_principal_component_method = PCA(n_components=3)
sk_principal_component_method.fit(sk_standard_scaled_data)
sk_principal_component_method_transformed_data = sk_principal_component_method.transform(sk_standard_scaled_data)

Listing 8-4Execute the Principal Component Method with the Scikit-Learn Framework


</pre>
<p>清单<a href="#PC5"> 8-5 </a>公开了使用弯头曲线的<em class="EmphasisTypeItalic "> k </em>的数量(见图<a href="#Fig1"> 8-1 </a>)。</p>
<p><img alt="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig1_HTML.jpg" src="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig1_HTML.jpg" style="width:42.82em"/></p>
<p>图 8-1</p><p class="SimplePara">使用肘形曲线揭示 k 的数量</p>


<pre>from sklearn.cluster import KMeans
import matplotlib.pyplot as plt
%matplotlib inline
elbow_range = range(1, 15)
sk_kmeans_method = [KMeans(n_clusters=x) for x in elbow_range]
sk_kmeans_method_score = [sk_kmeans_method[x].fit(sk_principal_component_method_transformed_data).score(sk_principal_component_method_transformed_data) for x in range(len(sk_kmeans_method))]
plt.plot(elbow_range, sk_kmeans_method_score)
plt.xlabel("Number of k")
plt.ylabel("Eigenvalues")
plt.show()

Listing 8-5Disclose the Number of K Using an Elbow Curve


</pre>
<p class="Para" id="Par10">图<a href="#Fig1"> 8-1 </a>显示曲线突然扭曲，这表明 k-means 方法必须包含三个分量。</p>

<h2 class="Heading">sci kit-在行动中学习</h2>
<p>本节使用 Scikit-Learn 框架执行 k-means 方法；参见清单<a href="#PC6"> 8-6 </a>。</p>
<pre>sk_kmeans_method = KMeans(n_clusters=3)
sk_kmeans_method_fitted = sk_kmeans_method.fit(sk_standard_scaled_data)

Listing 8-6Execute the K-Means Method Using the Scikit-Learn Framework


</pre>
<p>清单<a href="#PC7"> 8-7 </a>计算 Scikit-Learn k-means 方法的标签。</p>
<pre>sk_kmeans_method_labels = pd.DataFrame(sk_kmeans_method_fitted.labels_, columns = ["Labels"])

Listing 8-7Compute the Scikit-Learn K-Means Method’s Labels


</pre>
<p>列表<a href="#PC8"> 8-8 </a>计算聚类中心并确定它们的平均值和标准偏差(见表<a href="#Tab1"> 8-1 </a>)。</p>
<p>表 8-1</p><p class="SimplePara">质心统计</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><strong class="EmphasisTypeBold ">中心平均值</strong></p>
</th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><strong class="EmphasisTypeBold ">中心标准偏差</strong></p>
</th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">第一中心</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">-0.157489</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.942836</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">第二中心</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.129950</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.854012</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">第三中心</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">0.222984</p>
</td>
<td style="text-align: left;"><p class="SimplePara">0.891719</p>
</td>
</tr>
</tbody>
</table>

<pre>sk_kmeans_method = KMeans(n_clusters=3)
sk_kmeans_method_centers = sk_kmeans_method_fitted.cluster_centers_
sk_kmeans_method_centers = pd.DataFrame(sk_kmeans_method_centers, columns = ("1st center","2nd center","3rd center"))
sk_kmeans_method_centers_mean = pd.DataFrame(sk_kmeans_method_centers.mean())
sk_kmeans_method_centers_std = pd.DataFrame(sk_kmeans_method_centers.std())
sk_kmeans_method_centers_mean_std = pd.concat([sk_kmeans_method_centers_mean, sk_kmeans_method_centers_std], axis=1)
sk_kmeans_method_centers_mean_std.columns =["Center mean", "Center standard deviation"]
print(sk_kmeans_method_centers_mean_std)

Listing 8-8Compute Cluster Centers and Their Mean and Standard Deviation


</pre>
<p>清单<a href="#PC9"> 8-9 </a>确定 Scikit-Learn k-means 方法计算的缩放数据和标签(见图<a href="#Fig2"> 8-2 </a>)。</p>
<p><img alt="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig2_HTML.jpg" src="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig2_HTML.jpg" style="width:42.82em"/></p>
<p>图 8-2</p><p class="SimplePara">Scikit-Learn k-means 方法标签</p>


<pre>plt.scatter(sk_principal_component_method_transformed_data[:,0], sk_principal_component_method_transformed_data[:, 1],
            c=sk_kmeans_method_fitted.labels_,cmap="coolwarm", s=120)
plt.xlabel("y")
plt.show()

Listing 8-9Determine the PySpark K-Means Method ‘s Labels


</pre>
<h3 class="Heading">PySpark 在行动</h3>
<p class="Para" id="Par15">本节使用 PySpark 框架执行和评估 k-means 方法。</p>
<p>清单<a href="#PC10"> 8-10 </a>使用<code>findspark</code>框架准备 PySpark 框架。</p>
<pre>import findspark as initiate_pyspark
initiate_pyspark.init("filepath\spark-3.0.0-bin-hadoop2.7")

Listing 8-10Prepare the PySpark Framework


</pre>
<p>清单<a href="#PC11"> 8-11 </a>使用<code>SparkConf()</code>方法规定了 PySpark 应用程序。</p>
<pre>from pyspark import SparkConf
pyspark_configuration = SparkConf().setAppName("pyspark_kmeans_method").setMaster("local")

Listing 8-11Stipulate the PySpark App


</pre>
<p>清单<a href="#PC12"> 8-12 </a>使用<code>SparkSession()</code>方法准备 PySpark 会话。</p>
<pre>from pyspark.sql import SparkSession
pyspark_session = SparkSession(pyspark_context)
from pyspark.sql import SparkSession

Listing 8-12Prepare the Spark Session


</pre>
<p>清单<a href="#PC13"> 8-13 </a>使用<code>createDataFrame()</code>方法将本章前面创建的<code>pandas</code>数据帧更改为 PySpark 数据帧。</p>
<pre>pyspark_initial_data = pyspark_session.createDataFrame(initial_data)

Listing 8-13Change the Pandas Dataframe to a PySpark Dataframe


</pre>
<p>清单<a href="#PC14"> 8-14 </a>为独立特征创建一个列表，为从属特征创建一个字符串。然后，它使用 PySpark 框架建模的<code>VectorAssembler()</code>方法转换数据。</p>
<pre>x_list = list(initial_data.iloc[::, 0:3].columns)
from pyspark.ml.feature import VectorAssembler
pyspark_data_columns = x_list
pyspark_vector_assembler = VectorAssembler(inputCols=pyspark_data_columns, outputCol="features")
pyspark_data = pyspark_vector_assembler.transform(pyspark_initial_data)

Listing 8-14Transform the Data


</pre>
<p>清单<a href="#PC15"> 8-15 </a>使用 PySpark 框架执行 k-means 方法。</p>
<pre>from pyspark.ml.clustering import KMeans
pyspark_kmeans_method = KMeans().setK(3).setSeed(1)
pyspark_kmeans_method_fitted = pyspark_kmeans_method.fit(pyspark_data)

Listing 8-15Execute the K-Means Method Using the PySpark Framework


</pre>
<p>清单<a href="#PC16"> 8-16 </a>计算 k-means 方法的标签，并将它们传递给一个<code>pandas</code>数据帧。</p>
<pre>pyspark_yhat = pyspark_kmeans_method_fitted.transform(pyspark_data)
pyspark_yhat_pandas_df = pyspark_yhat.toPandas()

Listing 8-16Compute the PySpark K-Means Method ‘s Labels


</pre>
<p>清单<a href="#PC17"> 8-17 </a>显示了 PySpark k-means 方法计算的缩放数据和标签(见图<a href="#Fig3"> 8-3 </a>)。</p>
<p><img alt="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig3_HTML.jpg" src="../images/517508_1_En_8_Chapter/517508_1_En_8_Fig3_HTML.jpg" style="width:42.82em"/></p>
<p>图 8-3</p><p class="SimplePara">PySpark k 均值方法标签</p>


<pre>from mpl_toolkits.mplot3d import Axes3D
figure = plt.figure(figsize=(12, 12))
ax = Axes3D(figure)
ax.scatter(pyspark_yhat_pandas_df.iloc[::, 0],
           pyspark_yhat_pandas_df.iloc[::, 1],
           pyspark_yhat_pandas_df.iloc[::, 2],
           c = pyspark_yhat_pandas_df.iloc[::, 4],
           cmap = "coolwarm",
           s = 120)
ax.set_xlabel(initial_data.columns[0])
ax.set_ylabel(initial_data.columns[1])
ax.set_zlabel(initial_data.columns[2])
figure.show()

Listing 8-17Disclose the PySpark K-Means Method’s Labels


</pre>
<p>清单<a href="#PC18"> 8-18 </a>计算 PySpark k-means 方法的中心。</p>
<pre>pyspark_kmeans_method_centers = pyspark_kmeans_method_fitted.clusterCenters()
print("K-Means method cluster centers")
for pyspark_cluster_center in pyspark_kmeans_method_centers:
    print(pyspark_cluster_center)
K-Means method cluster centers
[26.5952381  33.14285714 65.66666667]
[45.30769231 60.52991453 34.47008547]
[32.97560976 88.73170732 79.24390244]

Listing 8-18Compute the PySpark K-Means Method’s Centers


</pre>
<p>清单<a href="#PC19"> 8-19 </a>使用剪影法评估 PySpark k-means 方法。</p>
<pre>from pyspark.ml.evaluation import ClusteringEvaluator
pyspark_kmeans_method_assessment = ClusteringEvaluator()
pyspark_kmeans_method_silhoutte = pyspark_kmeans_method_assessment.evaluate(pyspark_yhat)
print("Silhouette score = " + str(pyspark_kmeans_method_silhoutte))

Silhouette score = 0.45097978411312134




Listing 8-19Assess the PySpark K-Means Method Using the Silhouette Method


</pre>

<h3 class="Heading">H2O 在行动</h3>
<p class="Para" id="Par26">这部分使用 H2O 框架执行和评估 k-means 方法。</p>
<p>清单<a href="#PC20"> 8-20 </a>准备 H2O 框架。</p>
<pre>import h2o as initialize_h2o
initialize_h2o.init()

Listing 8-20Prepare the H2O Framework


</pre>
<p>清单<a href="#PC21"> 8-21 </a>将<code>pandas</code>数据帧更改为 H2O 数据帧。</p>
<pre>h2o_data = initialize_h2o.H2OFrame(initial_data)

Listing 8-21Change the Pandas Dataframe to an H2O Dataframe


</pre>
<p>清单<a href="#PC22"> 8-22 </a>概述了独立和从属特征。</p>
<pre>y = y_list
x = h2o_data.col_names
x.remove(y_list)

Listing 8-22Outline the Features


</pre>
<p>清单<a href="#PC23"> 8-23 </a>为训练和验证 H2O k 均值方法保留数据。</p>
<pre>h2o_training_data, h2o_validation_data = h2o_data.split_frame(ratios=[.8])

Listing 8-23Randomly Divide the Dataframe


</pre>
<p>清单<a href="#PC24"> 8-24 </a>执行 H2O k 均值方法。</p>
<pre>from h2o.estimators import H2OKMeansEstimator
h2o_kmeans_method = H2OKMeansEstimator(k=3)
h2o_kmeans_method.train(x = x_list, training_frame = h2o_training_data, validation_frame = h2o_validation_data)

Listing 8-24Execute the K-Means Method Using the H2O Framework


</pre>
<p>清单<a href="#PC25"> 8-25 </a>计算 H2O k 均值方法的标签。</p>
<pre>h2o_yhat = h2o_kmeans_method.predict(h2o_validation_data)

Listing 8-25Compute the H2O K-Means Method Labels


</pre>
<p>清单<a href="#PC26"> 8-26 </a>评估 H2O k 均值方法(见表<a href="#Tab2"> 8-2 </a>)。</p>
<p>表 8-2</p><p class="SimplePara">PySpark 质心统计</p>


<table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/>
<col class="tcol2 align-left"/>
<col class="tcol3 align-left"/>
<col class="tcol4 align-left"/>
<col class="tcol5 align-left"/>
</colgroup>
<thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">图心</p>
</th>
<th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">大小</p>
</th>
<th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">在 _cluster_sum_of_squares 内</p>
</th>
</tr>
</thead>
<tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Zero</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">One</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Seventy-eight</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">134.983658</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">one</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Two</p>
</td>
<td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Fifty-one</p>
</td>
<td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">69.748489</p>
</td>
</tr>
<tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Two</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"> </td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Three</p>
</td>
<td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Thirty-two</p>
</td>
<td style="text-align: left;"><p class="SimplePara">33.898533</p>
</td>
</tr>
</tbody>
</table>

<pre>from h2o.estimators import H2OKMeansEstimator
h2o_kmeans_method_assessment = h2o_kmeans_method.model_performance()
h2o_kmeans_method_assessment

ModelMetricsClustering: kmeans
** Reported on train data. **
MSE: NaN
RMSE: NaN
Total Within Cluster Sum of Square Error: 238.6306804611187
Total Sum of Square Error to Grand Mean: 479.99999503427534
Between Cluster Sum of Square Error: 241.36931457315666

Listing 8-26Assess the K-Means Method Executed with the H2O Framework


</pre>


<h2 class="Heading">结论</h2>
<p class="Para" id="Par34">本章执行了三个关键的机器学习框架(Scikit-Learn、PySpark 和 H2O ),以便将数据分组为三个集群。您看到了如何使用肘曲线来识别 k 的数量。为了评估这种方法，您采用了剪影法并查看了误差平方和。</p>



</body>
</html>