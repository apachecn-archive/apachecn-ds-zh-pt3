托马斯 mailund 2017 年

Thomas Mailund,《在 R 开始数据科学》, 10.1007/978-1-4842-2671-1_2

# 2.可再现分析

Thomas Mailund <sup class="calibre6">1</sup> 的缩写形式

①丹麦奥胡斯

典型的数据分析工作流程看起来是这样的:你收集你的数据，并把它放入一个文件或电子表格或数据库。然后，您运行一些用不同脚本编写的分析，可能在运行过程中保存一些中间结果，或者可能总是处理原始数据。你创建一些相关数据汇总的图表或表格，然后用文本编辑器或文字处理器写一份结果报告。这是典型的工作流程。大多数做数据分析的人都是这样做的，或者说是各种各样的。但这也是一个存在许多潜在问题的工作流程。

分析脚本和数据之间是分离的，分析和分析文档之间也是分离的。

如果所有的分析都是在原始数据上完成的，那么第一个问题就不是一个大问题。但是对于分析的不同部分有不同的脚本是很常见的，一个脚本存储中间结果，然后由下一个脚本读取。脚本描述了数据分析的工作流程，为了重现分析，您必须以正确的顺序运行所有脚本。通常，这种正确的顺序只在文本文件中描述，或者更糟糕的是，只在编写工作流的数据科学家的头脑中描述。更糟糕的是，它不会在那里停留很长时间，很可能在再次被需要之前就丢失了。

理想情况下，您总是希望以这样一种方式编写您的分析脚本，在这种方式下，您可以在任何时候完全自动地重新运行您的工作流的任何部分。

对于第二个问题，问题是即使工作流是自动化的并且容易再次运行，文档也很快脱离了实际的分析脚本。如果您更改了脚本，您不一定会记得更新文档。您可能不会忘记更新数字和表格等，但不一定要更新精确分析运行的文档。功能选项和过滤选项等等。如果文档偏离实际分析足够远，它就变得完全无用。您可以随时信任自动化脚本来表示真实的数据分析——这是拥有自动化分析工作流的好处——但是文档很容易变成纯粹的虚构。

您需要的是一种拥有动态文档的方法。以机器和人类都能理解的形式描述分析工作流程的报告。机器将报告作为自动工作流程，可以随时重复分析。我们人类使用它作为文档，总是准确地描述我们运行的分析工作流程。

## 有文化的编程以及工作流和文档的集成

实现自动化工作流和文档总是最新的目标的一种方法是所谓的“有文化的编程”。识字编程是一种软件开发方法，由斯坦福大学计算机科学家 Donald Knuth 提出，但它从未在编程中流行起来，可能是因为大多数程序员不喜欢编写文档。

文化编程的思想是程序的文档——在程序如何工作以及程序中的算法和数据结构如何工作的文档的意义上——与实现程序的代码一起编写。像 Javadoc 和 roxy gen([http://roxygen.org](http://roxygen.org))这样的工具做着类似的事情。他们有以注释形式与代码一起编写的类和方法的文档。识字编程与此略有不同。对于 Javadoc 和 Roxygen，代码是主要文档，文档是添加到其中的注释。对于有文化的编程来说，文档是人类阅读的主要文本，代码是文档的一部分，包含在自然存在的地方。当程序运行时，计算机代码自动从该文档中提取。

对于编写程序来说，有文化的编程从未取得巨大成功，但对于数据科学来说，它正在卷土重来。数据分析项目的结果通常是描述模型和分析结果的报告，并且很自然地将该文档视为主要产品。所以文档已经是主要焦点了。使用文化编程唯一需要的是将分析代码放入文档报告的方法。

许多编程语言都支持这一点。Mathematica([https://www.wolfram.com/mathematica/](https://www.wolfram.com/mathematica/))一直都有笔记本，你可以在上面写代码和文档。iPython Notebook 的后代 jupyter([http://jupyter.org](http://jupyter.org))让你用穿插着可执行代码的文档和图形编写笔记本。在 R 中，有几种方法可以编写文档，既可以用作自动化分析脚本，也可以用于生成报告。这些方法中最流行的是 R Markdown(用于编写这些文档)和 knitr(用于运行分析和生成报告)。

## 在 RStudio 中创建 R Markdown/knitter 文档

要创建新的 R Markdown 文档，请转到“文件”菜单，选择“新建文件”,然后选择“R Markdown”。现在，RStudio 将弹出一个窗口，您可以在其中决定要制作哪种文档，并添加一些信息，如标题和作者姓名。你在这里做什么并不重要；你可以以后再改。但是试着做一个 HTML 文档。

结果是一个新文件，其中有一些样板文本，如图 [2-1](#Fig1) 所示。在文件的顶部，两行之间是文档的一些元信息，第二行之后是实际的文本。它由 Markdown 语言格式的文本和 R 代码混合组成。

![A439481_1_En_2_Fig1_HTML.jpg](Images/A439481_1_En_2_Fig1_HTML.jpg)

###### 图 2-1。新的 R Markdown 文件

在打开文件上方的工具栏中，有一个名为 Knit HTML 的菜单选项。如果你点击它，它会把 R Markdown 翻译成 HTML 文档并打开，如图 [2-2](#Fig2) 所示。不过，您必须先保存文件。如果您在保存之前单击“编织 HTML”按钮，将会要求您保存文件。

![A439481_1_En_2_Fig2_HTML.jpg](Images/A439481_1_En_2_Fig2_HTML.jpg)

###### 图 2-2。编译的降价文件

新创建的 HTML 文件也以您给 R Markdown 文件的名称写入磁盘。R Markdown 文件将带有后缀。rmd 和 html 文件将具有相同的前缀，但带有后缀. HTML。

如果您单击 Knit HTML 旁边的齿轮标志(在 R Studio 的早期版本中，这是一个向下的箭头)，您会看到一些附加选项。您可以要求在 RStudio 右侧的窗格中查看 HTML 文档，而不是在新窗口中。如果您使用的是笔记本电脑，并且没有太多的屏幕空间，那么将文档放在面板中而不是单独的窗口中会很方便。您也可以生成文件或 Word 文件，而不是 HTML 文件。

如果您决定以不同的输出格式生成文件，RStudio 会记住这一点。它会将 Knit HTML 更新为 Knit 或 Knit Word，并且会更新文件头中的元数据。如果您手动更新标题，这将反映在针织 X 按钮中。如果您单击齿轮图标再向右移动一步，您会看到更多关于文档应该如何格式化的选项。

创建文档的实际步骤涉及两种工具和三种语言，但是它们都是集成的，所以您通常不会注意到。文档中嵌入了 R 代码。R 代码首先由 knitr 包处理，它对代码求值并根据您给它的选项处理结果，如数据和图形。结果是一个降价文件(通知编号 R)。这个 Markdown 文档然后由 pandoc 工具处理，pandoc 工具负责生成输出文件。为此，它在标题中使用元数据，元数据是用一种叫做 YAML 的语言编写的，而实际的格式是用 Markdown 语言编写的。

你通常不用担心 pandoc 作为文档处理的后端。如果你只是编写 R Markdown 文档，那么 RStudio 会让你把它们编译成不同类型的输出文档。但是因为管道是从 R Markdown 通过 knitr 到 Markdown，然后通过 pandoc 到各种输出格式，所以您可以使用一个非常强大的工具来创建文档。我用 R Markdown 写了这本书，其中每一章都是一个独立的文档，我可以在 knitr 中独立运行。然后，我让 pandoc 使用一些选项来获取生成的 Markdown 文档，合并它们，并生成 output 和 Epub 输出。使用 pandoc，可以使用不同的模板来设置格式，并使其依赖于通过对不同格式使用不同模板而创建的输出文档。它是一个非常强大，但也非常复杂的工具，远远超出了本书的范围。只要知道，如果你想在 R Markdown 中比在 RStudio 中更深入地编写文档，它就在那里。

正如我提到的，一个 R Markdown 文档实际上涉及到三种语言。我们将按顺序处理它们——首先是标题语言，即 YAML，然后是文本格式语言，即 Markdown，最后是 R 如何嵌入文档。

## YAML 语

YAML 是一种指定键值数据的语言。YAML 代表(递归)缩写 *YAML 不是标记语言*。所以，是的，当我称这个部分为“YAML 语言”时，我不应该包括*语言*，因为 *L* 代表语言，但是我包括了。我袖手旁观那个选择。这个首字母缩略词曾代表另一种标记语言，但由于“标记语言”通常指的是用于标记文本的命令，以指定格式或在文本中放置结构化信息，而 YAML 不这样做，所以这个首字母缩略词被改变了。YAML 是用来为处理文档的计算机程序提供各种形式的选项，而不是用来标记文本，所以它不是真正的标记语言。

在您的 R Markdown 文档中，YAML 用于标题，即第一行和第二行之间带有三个破折号的所有内容。在您创建新的 R Markdown 文件时创建的文档中，它看起来可能是这样的:

```py
---
title: "My Markdown Document"
author: "Thomas Mailund"
date: "17 July 2016"
output: html_document
---
```

您通常不需要手动修改该标题。如果您使用 GUI，它会在您更改选项时为您调整标题。不过，你确实需要修改它，使之包含书目，这一点我们稍后会讲到。如果需要的话，你可以在标题中添加任何你想添加的内容，这比使用 GUI 更容易。但是你不必经常修改标题。

YAML 为您提供了一种指定键值映射的方法。你写 key:然后是值。所以在上面，你有引用我的 Markdown 文档的关键标题，引用“Thomas Mailund”的关键作者等等。除非值中有冒号，否则您不一定需要引用它们，但是您总是可以这样做。

RStudio 和 pandoc 都使用 YAML 报头。RStudio 使用输出键来确定将文档翻译成哪种输出格式，这一选择反映在 **Knit** 工具栏按钮中。另一方面，pandoc 使用标题、作者和日期将这些信息放入生成的文档中。

键值规范的结构可以稍微多一点。如果一个键应该引用一个值列表，可以使用-。所以如果你有不止一个作者，你可以这样使用:

```py
---
...
author:
 - "Thomas Mailund"
 - "Christian Storm"
...
---
```

或者你可以有更多的嵌套键值结构，所以如果你改变输出主题(点击工具栏中的齿轮后使用输出选项)，你可能会看到如下所示:

```py
output:
  html_document:
    theme: united
```

如何使用这些选项取决于用来格式化文档的工具链。YAML 标题只是提供了规格。你有哪些选择和它们做什么不是语言的一部分。

对于 pandoc，它依赖于用来生成最终文档的模板(见后面)，所以我甚至没有一个完整的 pandoc 列表可以给你。任何编写新模板的人都可以决定使用新的选项。YAML 标题为您提供了一种为这种模板提供选项的方式，但是没有固定的一组关键字可以使用。这完全取决于过程后面的工具如何解释它们。

## 降价语言

Markdown 语言*是*一种标记语言——这个名字是一个双关语。最初开发它是为了方便编写网页。HTML 是一种用来格式化网页的语言，也是一种标记语言，但并不总是容易让人读懂。Markdown 试图通过用非常简单的标记命令格式化文本来解决这个问题——在电子邮件还是 HTML 文档之前，人们对电子邮件很熟悉——然后有工具将 Markdown 翻译成 HTML。

Markdown 已经远远超出了仅仅编写网页的范围，但它仍然是一种非常简单和直观的语言，用于编写带有标记命令的人类可读文本，然后这些文本可以被翻译成其他文档格式。

在 Markdown 中，您将纯文本写成纯文本。所以文本的主体是没有任何标记的。你需要在文本编辑器中编写它，这样文本实际上就是文本，而不是文字处理器，在文字处理器中，文件格式已经包含了许多在屏幕上不容易看到的标记信息。如果您正在编写代码，您应该已经了解了文本编辑器。如果没有，就用 RStudio 写 R Markdown 文件，就没事了。

当您需要除纯文本之外的其他内容时，可以使用标记命令。没有太多的命令需要学习——哲学是当你写的时候你应该关注文本而不是格式——所以他们很快就学会了。

### 格式化文本

首先，有部分标题。你可以有不同层次的标题，比如章、节、小节等等。—并且在新行的开头使用# starting 来指定它们。

```py
# Header 1
## Header 2
### Header 3
```

对于前两种，您也可以使用这种格式:

```py
Header 1
========

Header 2
--------
```

要在文档中包含列表，可以像在原始文本文档中经常看到的那样编写它们。有项目符号(而不是数字)的列表是这样写的:

```py
 * this is a
 * bulleted
 * list
```

结果看起来像这样:

*   这是一个

*   由实心圆点引出的

*   目录

只需缩进就可以拥有子列表。您需要将缩进的行移入，以便在文本从外部杠杆开始的位置和项目符号在下一级的位置之间有一个空格。否则，该线位于外层。这个的输出:

```py
 * This is the first line
    * This is a sub-line
    * This is another sub-line
   * This actually goes to the outer level
 * This is definitely at the outer level
```

这个列表是:

*   这是第一行

    *   这是一条副线

    *   这是另一条子线

*   这实际上是在外层

*   回到外层

如果你愿意，你可以在这些列表中使用-而不是*,并且你可以混合使用这两个选项。

```py
 - First line
 * Second line
    - nested line
```

*   首行

*   第二人生

    *   嵌套线

要有编号列表，只需用数字代替*和-。

```py
 1\. This is a
 2\. numbered
 3\. list
```

结果看起来像这样:

1.  这是一个

2.  有限的

3.  目录

你实际上不需要得到正确的数字，你只需要使用数字。因此

```py
 1\. This is a
 3\. numbered
 2\. list
```

会产生相同的(正确编号的)输出。你会从第一个数字开始数，所以

```py
 4\. This is a
 4\. numbered
 4\. list
```

生产:

4.这是一个

5.有限的

6.目录

为了构造表格，还可以使用带有垂直线和水平线的典型文本表示。垂直线分隔列，水平线分隔标题和表体。此代码:

```py
| First Header  | Second Header | Third Header    |
| :------------ | :-----------: | --------------: |
| First row     | Centered text | Right justified |
| Second row    | *Some data*   | *Some data*     |
| Third row     | *Some data*   | *Some data*     |
```

将产生此表:

<colgroup class="calibre15"><col class="calibre16"> <col class="calibre16"> <col class="calibre16"></colgroup> 
| 

第一个标题

 | 

第二标题

 | 

第三个标题

 |
| --- | --- | --- |
| 第一排 | 居中文本 | 右对齐 |
| 第二排 | *一些数据* | *一些数据* |
| 第三排 | *一些数据* | *一些数据* |

分隔标题和正文的行中的:决定了列的对齐方式。将它放在左边以获得左对齐，放在两边以获得文本居中，放在右边以获得文本右对齐。

在文本内部，您可以使用标记代码将文本变成斜体或粗体。你可以用*this*或 _this_ 来使 *this* 变成斜体，而用**this**或 __this__ 来使 **this** 变成粗体。

既然 Markdown 是为制作 HTML 文档而开发的，它当然有一种插入链接的简单方法。使用符号[链接文本](链接 URL)将链接文本作为链接 URL 的链接放入文档。这种符号也用于在文档中进行交叉引用——类似于 HTML 文档中的锚点和内部链接——但是后面会详细介绍。

要将图像插入到文档中，您可以使用类似于链接符号的符号，但是您只需将！链接之前。所以！[图像描述](URL to image)将插入 URL to image 指向的图像，并带有标题“图像描述”。这里的 URL 通常是本地文件，但也可以是通过 HTTP 引用的远程文件。

对于长 URL，即使使用这种简单的符号，标记的文本也可能难以阅读，可以将 URL 从实际文本中删除，并将其放在文档的后面，例如，在引用 URL 的段落之后或文档的末尾。为此，您使用符号[链接文本][链接标签]，并将链接标签定义为您稍后想要的 URL。

```py
This is some text [with a link][1].
The link tag is defined below the paragraph.

[1]: interesting-url-of-some-sort-we-dont-want-inline
```

您可以在这里使用字符串作为标签。使用数字很容易，但是对于长文档，您将无法记住每个数字所指的内容。

```py
This is some text [with a link][interesting].
The link tag is defined below the paragraph.

[interesting]: interesting-url-of-some-sort-we-dont-want-inline
```

你可以在文本中使用你在电子邮件中熟悉的符号来引用。

```py
> This is a
> block quote
```

给你这个:

这是一段引语

要将逐字输入作为文本的一部分，您可以内联或以块的形式进行。在这两种情况下，您都要使用反斜线`。在文本的内联中，使用单反斜杠“foo”。要创建您编写的文本块:

```py
```
block of
text
```py
```

你也可以只让文本缩进四个空格，这就是我如何设法制作一个包含三个反勾号的逐字文本块。

编写程序文档的人经常使用 Markdown，因此有一种在逐字块中突出显示代码的符号。惯例是将编程语言的名称写在三个反勾号之后，然后用于格式化文档的程序将高亮显示代码。对于 R 代码，你写 R，所以这个块:

```py
```r
f <- function(x) ifelse(x %% 2 == 0, x**2, x**3)
f(2)
```py
```

格式如下:

```py
f <- function(x) **ifelse**(x %% 2 == 0, x**2, x**3)
**f**(2)
```

这种块标记所做的唯一事情就是突出显示代码。它不会尝试评估代码。评估代码发生在 Markdown 文档被格式化之前，我们稍后再回到这个问题。

### 交叉引用

开箱即用，在 Markdown 文档中没有太多的交叉引用支持。您可以对章节进行交叉引用，但不能对图表或表格进行交叉引用。使用 pandoc 的扩展有很多方法可以做到这一点——我在本书中使用了它——但是在 RStudio 中，您不能这样做。虽然，随着写书和冗长报告的工作在 book down([https://bookdown.org/yihui/bookdown/](https://bookdown.org/yihui/bookdown/))中完成，这种情况可能很快就会改变。 [<sup class="calibre6">1</sup>](#Fn1)

引用节的最简单的方法是将节的名称放在方括号中。如果我在这里写[交叉引用],我会得到这个交叉引用部分的链接。当然，您并不总是希望节的名称成为链接的文本，因此您也可以编写[本节][交叉引用]来获得本节的链接。

这种方法自然只有在所有部分标题都是唯一的情况下才有效。如果他们不是，你不能仅仅通过他们的名字来称呼他们。相反，您可以标记它们，给它们一个唯一的标识符。您可以通过在该部分的标题后写入标识符来实现这一点。要在节标题后添加名称，您可以写:

```py
### Cross referencing {#section-cross-ref}
```

然后你就可以用[this](#section-cross-ref)来参考小节了。在这里，您需要在标识符中使用#号。这种标记是 HTML 遗留下来的，锚使用#。

### 书目

你经常想在报告中引用书籍或论文。当然，您可以手动处理引用，但是更好的方法是创建一个包含引用信息的文件，然后使用标记来引用它。要添加参考书目，可以在 YAML 标题中使用一个名为参考书目的标签。

```py
---
...
bibliography: bibliography.bib
...
---
```

您可以在这里使用几种不同的格式；列表见[R Markdown 文档](http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html)([http://rmarkdown . R studio . com/authoring _ bibliographies _ and _ citations . html](http://rmarkdown.rstudio.com/authoring_bibliographies_and_citations.html))。后缀。围嘴是用来围嘴的。引用文件的格式与 BibTeX 相同，您可以从几乎所有提供参考书目信息的站点获得这种格式的引用信息。

要引用参考文献中的内容，可以使用[@smith04]，其中 smith04 是参考文献文件中使用的标识符。你可以在方括号内引用多篇论文，用分号隔开，[@ Smith 04；doe99]，并且可以添加章节或页码等文字[@smith04，chapter [4](04.html) ]。要在引文中隐藏作者姓名，比如说当你在正文中提到已经存在的姓名时，你要在@前面加上---------------------------------------------------------------------------------------------------------- ------------------------------------------....对于文本内引用，类似于 natbib 中的\citet{}，您只需去掉括号:@smith04 显示...你可以将它与其他引用信息结合起来，如@ Smith 04[第 [4](http://dx.doi.org/10.1007/978-1-4842-2671-4) 章]所示....

要指定要使用的引用样式，可以在 YAML 标题中使用 csl 标签。

```py
---
...
bibliography: bibliography.bib
csl: biomed-central.csl
...
---
```

在[https://github.com/citation-style-language/styles](https://github.com/citation-style-language/styles)查看大量不同格式的引用风格列表。那里应该有大部分，如果不是全部，你内心的渴望。

### 控制输出(模板/样式表)

pandoc 工具有一个强大的机制来格式化它生成的文档。这是通过使用 HTML 的 CSS 中的样式表和使用模板来格式化所有输出格式的输出来实现的。模板机制允许您编写一个 HTML 或 LaTeX 文档，比如说，确定文本的各个部分放在哪里，以及在哪里使用 YAML 头中的变量。这个机制远远超出了我们在这一章所能涵盖的范围，但是如果你想开始用 R Markdown 写论文，我只想提一下。你可以做到这一点，你只需要有一个模板来格式化一个杂志想要的风格的文件。他们经常提供 LaTeX 模板，你可以修改这些模板来使用 Markdown。

RStudio 对此没有太多支持，但对于 HTML 文档，您可以使用输出选项命令(单击齿轮)来选择不同的输出格式。

## 在降价文档中运行 R 代码

到目前为止的格式都是降价(和 YAML)。它与 R 结合并使之成为 R Markdown 的地方是通过 knitr。当您格式化文档时，第一步是评估 R 代码以创建 Markdown 文档。这将一个。rmd 文档转换成。md 文档，但是这个中间文档随后会被删除，除非您明确地告诉 RStudio 不要这样做。它通过运行您想要执行的所有 R 代码并将其放入 Markdown 文档中来实现这一点。

您可以评估的最简单的 R 代码是文本的一部分。如果你想计算一个 R 表达式，你可以使用反斜线，但是要在第一个反斜线后面加上 R。因此，要计算 2 + 2 并将结果放入 Markdown 文档中，可以先写“r ”,然后写表达式 2 + 2，并将结果 4 插入文本中。你可以在那里写任何 R 表达式来计算它。这对于将简短的汇总统计数据(如平均值和标准偏差)直接插入到文本中非常有用，并且可以确保汇总数据始终与您正在分析的实际数据保持一致。

对于较长的代码块，您使用块引号，即三个反勾号。不只是写:

```py
```r
2 + 2
```py
```

这将只显示代码(突出显示为 R 代码)，您将 R 放在花括号中。

这将在您的文档中插入代码，但也会在代码块之后显示评估结果。在 RStudio 中创建 R Markdown 文档时得到的样板代码向您展示了这样的例子(参见图 [2-3](#Fig3) )。

![A439481_1_En_2_Fig3_HTML.jpg](Images/A439481_1_En_2_Fig3_HTML.jpg)

###### 图 2-3。RStudio 中的代码块

你可以通过在 r 后面加一个名字来命名代码块，你不需要命名所有的块，如果你有很多块，你可能不会费心去命名所有的块。但是如果您给它们起一个名字，通过点击文档下面的栏中的结构按钮，可以很容易地找到它们(见图 [2-4](#Fig4) )。在缓存结果时，您也可以使用这个名称来引用块，我们将在后面介绍。

![A439481_1_En_2_Fig4_HTML.jpg](Images/A439481_1_En_2_Fig4_HTML.jpg)

###### 图 2-4。具有组块名称的文档结构

如果你有最新版本的 RStudio，你应该会在每个代码块的右边看到一个工具栏(见图 [2-5](#Fig5) )。最右边的选项，播放按钮，将让您评估块。除非您禁用了该选项，否则结果将显示在块的下方。中间的按钮评估所有以前的块，包括当前块。当当前块依赖于以前的结果时，这很有用。齿轮可以让你设置块的选项。

![A439481_1_En_2_Fig5_HTML.jpg](Images/A439481_1_En_2_Fig5_HTML.jpg)

###### 图 2-5。代码块工具栏

块选项，如图 [2-6](#Fig6) 所示，控制着评估代码块时得到的输出。Output 下拉菜单选择块应该在结果文档中生成什么输出，而 Show Warnings 和 Show Messages 按钮分别决定是否应该在输出中包含警告和消息。“使用自定义图形大小”按钮用于确定您生成的图形的大小。我们稍后再回到这些。

![A439481_1_En_2_Fig6_HTML.jpg](Images/A439481_1_En_2_Fig6_HTML.jpg)

###### 图 2-6。代码块选项

如果您修改这些选项，您将看到这些选项包含在块的顶行中。当然，您也可以手动控制这里的选项，除了您可以在 GUI 窗口中控制的选项之外，还有更多选项。你可以阅读所有细节的编织文档([http://yihui.name/knitr/](http://yihui.name/knitr/))。

这个对话框将处理您的大部分需求，除了显示表格或者当您想要缓存块的结果时，这两种情况我们稍后将返回。

### 分析数据时使用块(不编译文档)

不过，在继续之前，我想强调在 R Markdown 文档中使用数据分析不仅仅是创建文档。我个人在这些文档中做我所有的分析，因为我可以将文档和代码结合起来，不管我是否想在最后生成一个报告。说明文字和分析代码的结合，只是方便拥有。

将代码块作为单独的分析片段进行评估的方式也是其中的一部分。你可以单独评估块，或者评估某一点上的所有块，我发现这在做分析时非常方便。有用于评估所有块、所有以前的块或仅当前块的键盘快捷键(见图 [2-7](#Fig7) )，这使得编写一点代码用于探索性分析和仅评估那段代码变得非常容易。如果你熟悉 Jupyter 或者类似的笔记本，你会认可这个工作流程。

![A439481_1_En_2_Fig7_HTML.jpg](Images/A439481_1_En_2_Fig7_HTML.jpg)

###### 图 2-7。评估区块的选项

即使没有从 Markdown 文档生成最终文档的选项，我仍然会仅仅为了这个特性而使用它们。

### 缓存结果

有时分析的一部分非常耗时。这里我指的是 CPU 时间，而不是思考时间——思考时间也是如此，但你不需要一遍又一遍地思考同样的事情。然而，如果你不小心，你将需要在计算机上一次又一次地运行同样的分析。

如果你的分析中有这样耗时的步骤，那么编译文档会非常慢。每次编译文档时，所有的分析都是从头开始的。这是您想要的功能，因为这可以确保分析不会留下不属于文档一部分的代码的结果，但是如果编译工作流需要几个小时，它会限制工作流的可用性。

为了缓解这种情况，您可以缓存块的结果。要缓存块的结果，应该给它添加 cache=TRUE 选项。这意味着将它添加到块的头部，类似于添加输出选项的方式。您需要给这个块起一个名字来使用它。没有名字的块实际上被赋予了一个默认的名字，但是这个名字会根据你在文档中有多少个未命名的块而改变，如果你使用这个名字来记住结果，你就不能拥有它。所以你需要给它起个名字。设置为缓存的命名块不仅在编译文档时会被缓存，如果它在上次评估后发生了更改。如果它没有改变，那么上一次评估的缓存结果将被重用。

r 不能缓存所有的东西，所以如果你在一个缓存的块中加载库，它们不会被加载，除非这个块被求值。这意味着您可以做的事情有一些限制，但通常这是一个非常有用的功能。

由于其他块可以依赖于一个缓存块，所以如果一个缓存块依赖于另一个块(无论是否缓存),也会出现问题。只有当你修改了程序块中的代码时，程序块才会被重新评估，所以如果它依赖于你修改过的东西，它会记住基于过时数据的结果。对此你必须小心。

不过，您可以设置块之间的依赖关系来解决这个问题。如果一个块依赖于另一个块的结果，可以使用块选项 dependson=other 来指定。然后，如果块 other(您需要命名这样的块)被修改，缓存被认为是无效的，依赖的块将被再次评估。

### 显示数据

既然你在写一份关于数据分析的报告，你自然想包括一些结果。这意味着以某种形式显示数据。

您可以简单地将 R 表达式的计算结果包含在代码块中，但是通常您希望使用表格或图形来显示数据，尤其是当您希望向不熟悉 R 的人展示报表时。幸运的是，表格和图形都很容易显示。

要制作一个表格，可以使用 knitr 包中的函数 kable()。试着在你的样板文档中添加一个这样的块:

```py
**library**(knitr)
**kable**(**head**(cars))
```

库(knitter)从 knitter 包中导入函数，因此您可以访问 kable()函数。您不需要将它包含在您使用 kable()的每个块中，只需在使用该函数之前将其包含在任何块中即可 setup 块是一个好地方——但是将它添加到块中，您现在编写的将会起作用。

函数 kable()将从 Markdown 格式的数据帧中创建一个表格，以便在文档编译的后续步骤中对其进行格式化。这里不用太担心代码中的细节；head()函数只挑选汽车数据的第一行，这样表格就不会太长。

使用 kable()应该会在输出文档中生成一个表格。根据您的设置，您可能需要给这个块提供输出选项 result="asis "来使它工作，但是即使没有这个选项，它通常也会给您一个表。

我们将在后面的章节中介绍如何汇总数据。通常，您不希望制作完整数据集的表格，但是现在，您可以尝试只获取汽车数据的前几行。

向输出中添加图形也很简单。您只需在代码块中绘制一个图，结果将包含在您生成的文档中。样板 R Markdown 文档已经给了你一个这样的例子。我们将在后面更详细地介绍绘图。

## 练习

尝试以下练习，以便更好地理解本章中讨论的概念。

### 创建 R Markdown 文档

转到文件菜单，创建一个 R Markdown 文档。通读样板文本，看看它是如何构成的。评估块。编译文档。

### 产生不同的输出

从同一个 R Markdown 文档创建一个 HTML 文档、一个文档和一个 Word 文档。

### 添加缓存

将缓存的代码块添加到文档中。让那里的代码成为样本随机数，例如使用 rnorm()。当您重新编译文档时，您应该看到随机数没有改变。

创建另一个缓存块，使用第一个缓存块的结果。比方说，计算随机数的平均值。设置依赖关系，并验证如果修改第一个块，是否会计算第二个块。

# 脚注

在任何情况下，根据我的经验，有章节而没有图表的交叉引用仍然比 Word 好，Word 的功能是有的，但是错误百出，到了无用的地步。