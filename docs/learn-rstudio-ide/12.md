# 十二、R 编程

在这最后一章中，我们将回顾你需要知道的进行 R 编程的基本概念。本教程并不全面，也不意味着是你第一次体验编程。然而，如果你以前编程过，这将为你提供足够的 r 入门知识，完全不熟悉编程的读者可能会考虑参加一个关于这个主题的强化课程，也许是 Data Camp 或 Coursera。

## 目标

R 中的一切都是对象。一个对象可以是一列数字、一个函数、一个图或一个分析结果。有不同类型的对象，如列表、数据框和字符。

用赋值操作符`<-`创建一个对象。左边是您选择的名称，后面是赋值操作符`<-`，然后是定义对象的代码。您可以像这样创建一个数字对象:

```py
a <- 9

```

第一部分`a`是我们为对象选择的名称，接下来是赋值操作符`<-`，然后是一个值`9`。我们现在将通过使用字母 a 在代码中引用该对象。例如，如果我们想知道如何使`a`的值加倍，我们可以这样做:

```py
a * 2

```

这会将`18`打印到控制台。r 中的对象可以是不同的类型，上面的对象`a`就是`numeric`。这些类型在 r 中被称为类，你可以通过使用`class`函数找出一个对象的类是什么。

```py
class(a)

```

这将把值`numeric`返回到您的控制台。您可以使用赋值运算符来更改对象的类，如下所示:

```py
class(a) <- "custom_numeric"

```

通常，您不会更改已经存在的对象类，如数字或字符。但是，如果您正在创建自己的自定义类，并且希望将您的对象与环境中的其他对象区分开来，您可以这样做。

### 基本类别类型

在编写代码时，我们可以定义和使用多种类型的对象，但是有一些是 R 编程的基础，所以下面将具体介绍这些对象。

#### 字符和数字

我们在第一节中讨论了数字对象，字符对象也以同样的方式工作。真正的区别在于字符对象存储的是字符而不是数字。字符对象需要用单引号或双引号括起来，如下所示:

```py
b <- "nine"

```

当我们在代码中引用`b`时，我们将得到返回的字符串“九”。与我们之前看到的数字对象不同，我们不能将`b`乘以 2。如果我们尝试这样做，我们会得到错误“二元运算符的非数字参数”。

虽然我们不能对角色对象进行数学运算，但是我们可以使用`stringr`库来操作这些对象。例如，如果我们想将两个角色对象组合在一起，我们可以使用`stringr`库中的`str_glue`函数，如下所示:

```py
library(stringr)
str_glue(b, " times 2")

```

这将返回字符串“9 乘以 2”。关键字`library`用于让我们访问函数库。上面的第一行代码意味着我们需要访问`stringr`库。

#### 矢量

向量是同一类型对象的列表。您可能有一个字符、数字或其他类型对象列表。您使用从 1 开始的数值来跟踪列表中的对象。要创建一个向量，可以使用名为`c`的函数，该函数采用逗号分隔的值列表来创建列表。下面是如何创建一个包含组成字母表的前五个字母的向量:

```py
alpha <- c("A", "B", "C", "D", "E")

```

您可以简单地通过输入名称`alpha`将整个列表打印到控制台，或者您可以通过使用对象名称后跟方括号来引用单个元素，方括号带有与您感兴趣的向量中的元素相对应的索引。

例如，如果您`alpha[1]`将打印“A”，而`alpha[5]`将打印“E”。

当你对一个向量应用乘法或函数等运算时，该运算将应用于向量中的每个对象。结果将是一个新的向量。例如，如果我们有一个数字为 20、30、40、50 和 60 的向量，然后将该向量乘以 4，我们将得到一个新的向量 80、120、160、200 和 240。

```py
n <- c(20,30,40,50,60)
n
[1] 20 30 40 50 60
n * 4
[1]  80 120 160 200 240

```

#### [数]矩阵

矩阵是一个二维向量(本质上是行和列)。像向量一样，矩阵中的每个对象必须是相同的类型。可以通过设置 vector 的 dim (for dimension)属性来创建矩阵，如下所示:

```py
m <- c(1,2,3,4,5,6,7,8,9)
dim(m) <- c(3,3)
m

```

当你检查`m`时，你会看到矩阵:

```py
     [,1] [,2] [,3]
[1,]    1    4    7
[2,]    2    5    8
[3,]    3    6    9

```

要引用矩阵中的单个单元格，需要提供行和列索引。例如，要查看第 2 行和第 2 列中的内容，您可以对`m[2,1]`执行此操作以获得值 2。

#### 目录

我们之前讨论的向量被称为原子向量，因为它们必须包含所有相同的元素。包含混合对象的向量简称为列表。当您想要管理相关对象的集合时，列表非常方便。

要创建一个新的列表，您可以像这样使用 list 函数:

```py
l <- list()
l$name <- "Cards"
l$cards <- c("10","Jack","Queen","King","Ace")
l$bets <- c(1,5,10)

```

第一行创建了一个空列表，然后使用`$`来创建名称以分配对象。第一个是描述列表的字符对象，第二个是字符的向量，最后一个是数值对象的向量。要在以后访问这些值，您必须使用列表名，后跟美元符号`$`和对象名。例如，要查看卡片列表，您可以键入`l$cards`，要获取列表中的第二张卡片，您可以键入`l$cards[2]`。

#### 因素

因子是只能包含指定值的向量类型。例如，您可能有一个表示性别的值列表，每个值必须是“男性”、“女性”或“未知”当我们分析对象的类别时，这种结构在这些情况下很方便。

您可以使用因子函数并提供值列表来创建因子。

```py
sex <- factor(c("male","female","unknown","male"))
sex

```

该代码输出以下信息:

```py
[1] male    female  unknown male
Levels: female male unknown

```

我们有一个值列表，就像在向量中一样，但是我们也有额外的层次信息。

#### 数据帧

数据框是一种特殊的列表，它必须具有长度相等的组件。实际上，这提供了一种类似电子表格的由行和列组成的二维数据结构。您可以将数据框组件视为使用`$`运算符的列表，或者使用行和列索引的矩阵。

您可以使用`data.frame`功能创建一个数据框:

```py
df <- data.frame(numbers = c(1,2,3),
                 letters = c("A","B","C"))
df$more <- c("1st","2nd","3rd")

```

当您使用`data.frame`功能创建数据框时，您可以为其提供所有长度相同的向量。一旦有了数据框，就可以使用`$`操作符创建额外的列，如上所示。

通常，会有一个为您创建的数据框作为函数的输出。数据帧是基本的 R 对象，数据帧的“tibble”版本类型在“基本 R 包”一章中有详细介绍。

### 流控制

到目前为止，我们基本上已经创建了对象，设置了属性，并检查了结果。r 编程还包括使用循环转移代码和重复代码的方法。

#### If-Then 语句

if-then 语句指示我们的程序根据某些对象的状态采取不同的动作。下面是一个 if-then 语句的示例:

```py
state <- "startup"

if(state == "startup") {
  print("We are about to start the program")
  state = "running program"
} else {
  print("Program running")
}

```

我们有一个名为`state`的对象，其值为“startup”。下一行代码评估 state 对象，如果对象等于“startup ”,那么花括号中 if 语句后面的代码将执行。将打印一条状态信息，并且`state`对象的值将改变。

如果`state`对象不是“startup ”,则执行`else`关键字后的代码。在这里，程序将简单地打印出消息“程序正在运行”。

在上面的例子中，我们使用了`==`操作符来测试这两个值是否相等。还可以测试不相等`!=`，大于`>`，小于`<`，大于等于`>=`，小于等于`<=`。

你也可以在一行代码中使用 if-else，如果你有简洁的代码，这样做很好。例如，如果我们只想测试`state`对象，看看它是否处于启动模式，我们可以简单地这样做:

```py
ifelse(state == "startup", TRUE, FALSE)

```

如果`state`是“启动”，那么我们将得到布尔值`TRUE`。否则我们得到布尔值`FALSE`。布尔是一种特殊类型的对象，只能为真或为假，用于测试类似这样的条件。

#### 环

循环给了我们一种重复相同代码的方法。我们可以在 R 中使用两种类型的循环:for 循环和 while 循环。我们还使用 apply 系列函数来提供类似循环的行为。让我们看看循环是如何工作的。

#### For 循环

For 循环将执行指定的次数。例如，如果您想循环五次代码，您可以这样做:

```py
for (i in 1:5){
  print(i)
}

```

这将打印出数字 1 到 5。这段代码由关键字`for`组成，在括号中我们有一个对象`i`来跟踪我们在循环中的位置。`1:5`是从 1 到 5 的简写。该循环将运行 5 次，每次运行花括号之间的代码都会产生以下输出:

```py
[1] 1
[1] 2
[1] 3
[1] 4
[1] 5

```

#### While 循环

While 循环也重复执行代码。但是，这些循环不是执行固定的次数，而是一直运行到满足某个条件。这就是我们用 while 循环从 1 数到 5 的方法:

```py
i <- 0

while (i <= 5) {
  print(i)
  i <- i + 1
}

```

while 循环检查`i`对象的状态，并将值打印到控制台，直到条件`i <= 5`为假。每当循环迭代一次，`i`的值就增加 1。

#### 应用功能

apply 系列函数也将提供循环模式，但形式更紧凑。您会在各种 R 包和 base R 中发现这种类型的函数。一般模式是通过传递一个对象(如 vector、data frame 或 list)来使用 apply 函数，apply 函数将遍历该对象中的每个元素。您为 apply 函数提供了针对每个元素执行的代码，该函数返回一个新的对象。

要复制我们到目前为止对循环所做的工作，我们可以这样做:

```py
sapply(1:5, function(x){print(x)})

```

这要干净得多，我们实际上只有向量`1:5`和要执行的代码。请注意，该代码是一个“匿名函数”，函数将在接下来更详细地讨论。基本上，我们定义了一个函数，它有一个参数`x`，这个参数是向量中当前值的占位符，在花括号之间，我们有将为向量中的每个元素执行的代码。

我们在这里使用了`sapply`函数，这个版本的 apply 函数返回一个简化的对象(在这个例子中是一个矢量)。在上面的例子中，我们只是得到相同的向量。然而，我们本可以做得更像这样:

```py
sapply(1:5, function(x){
  x * 2
  })

```

为了让代码更加清晰，我们在这里使用了匿名函数。这段代码将生成一个新的向量，并将其打印到控制台:

```py
[1]  2  4  6  8 10

```

这个 apply 函数是一个通用的包装函数，它返回最简单的对象。我们还有用于列表和数据框的`lapply`,它们以同样的方式工作，但是返回列表对象。

### 功能

函数是一种包含代码块的对象，可以通过向函数提供输入来执行。这些对象是遵循一次编写代码的最佳实践的好方法。一般来说，您认为可以在整个项目中使用的任何代码块都可以包装成一个函数，供以后使用。下面是创建函数对象的方法:

```py
my_fun <- function(x, y) {
  r = x * 2 + y
  r
}

```

花括号`{`和`}`之间的代码组成了这个函数。在这些花括号中，您可以创建新的对象和引用对象，这些对象在函数中被声明为参数。参数在逗号分隔的列表中声明，该列表出现在 function 关键字后的括号中。函数也可以使用在函数外部声明的对象，只要这些对象是在函数本身之前声明的。

包含参数列表和代码块的功能被分配给`my_fun`对象。我们可以通过在控制台中键入对象名来检查函数，以获得函数中代码的打印输出。

为了使用该函数，我们必须键入函数名，后跟逗号分隔的参数列表，如下所示:

```py
my_fun(3, 189)

```

这将返回数字对象`195`。函数中发生的是执行每一行代码，最后一行代码返回给调用者。`my_fun`中的最后一行代码是计算的结果。

没有指定对象名的函数被称为匿名函数，通常被用作函数`lapply`或`sapply`的参数。这些函数以相同的方式工作，但不一定像标准函数那样被重用。

### 导入 JSON 数据

JSON(JavaScript 对象符号)是一种数据格式，与 csv 或其他二维数据格式相比，有些程序员可能不太熟悉。JSON 数据格式被设计成可以以文本格式轻松发送，同时保持结构化格式。

下面是一个 JSON 数据的例子:

```py
[{"year":2015,"race":"All Races","sex":"Both Sexes","death":733.1},{"year":2014,"race":"All Races","sex":"Both Sexes","life":78.9,"death":724.6},{"year":2013,"race":"All Races","sex":"Both Sexes","life":78.8,"death":731.9},{"year":2012,"race":"All Races","sex":"Both Sexes","life":78.8,"death":732.8},{"year":2011,"race":"All Races","sex":"Both Sexes","life":78.7,"death":741.3},{"year":2010,"race":"All Races","sex":"Both Sexes","life":78.7,"death":747}]

```

这是我们在整本书中使用的预期寿命数据的一部分。您可能会对这些数据有所了解，但这远不是一种友好的格式。

要处理这样的数据，你可以使用`jsonlite`包。使用以下代码安装此软件包:

```py
install.packages("jsonlite")

```

现在，假设我们已经将上面的 JSON 数据存储在一个名为`life_json`的对象中，我们可以将数据转换成一种整齐的格式，我们可以使用这一行简单的代码:

```py
library(tidyverse)
library(jsonlite)
life <- fromJSON(life_json)

```

我们在上面包括了图书馆参考资料。您可以通过在命令行中键入对象名称 life 来检查结果，以获得以下数据框:

```py
year      race        sex death life
1 2015 All Races Both Sexes 733.1   NA
2 2014 All Races Both Sexes 724.6 78.9
3 2013 All Races Both Sexes 731.9 78.8
4 2012 All Races Both Sexes 732.8 78.8
5 2011 All Races Both Sexes 741.3 78.7
6 2010 All Races Both Sexes 747.0 78.7

```

`jsonlite`包`fromJSON`函数自动将文件转换成数据帧。该函数将自动返回最高级别的对象。因为我们的数据恰好符合我们所收到的数据框架。但是，如果底层数据框架不适合这种结构，您可能会得到一个反映 JSON 文件结构的列表对象。

## 结论

在这一章中，我们已经介绍了足够多的关于 R 编程的信息，以帮助你入门，并确保你能理解这本书的内容。现在，您应该理解 R 中的对象、控制流和函数。此外，如果您过去做过数据分析，那么关于基本 R 包的章节和关于 JSON 的章节将为您提供一个坚实的开端。

对于不熟悉数据分析和/或编程的读者，您可能会发现自己需要更多的帮助。编程在开始时需要大量的练习和理解。回顾其他程序员的数据分析工作，你可能会从中受益。很多例子可以在 Github 等网站上找到。

完全不熟悉编程的读者可能想花些时间学习基本编程。如果这本书是你第一次接触到诸如循环、函数和对象之类的概念，那么你应该考虑参加本地或在线的 R 编程课程。

对于每个人来说，我们希望本书和本章中的材料能够帮助你了解你可以使用哪些工具，这样你就可以真正开始深入了解你正在寻找的工作。祝您好运，并希望您享受进入数据科学技术的旅程！