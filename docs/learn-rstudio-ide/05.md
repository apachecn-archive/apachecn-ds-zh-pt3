# 5.可重复分析

让我们看看如何使用 RStudio 项目创建可重复的分析。对于这个例子，我们将使用我们在前一章中创建的名为“life _ expectancy”的项目。该数据集将来自美国国家健康统计中心，将描述美国自 1900 年以来的预期寿命。

如果您一直在跟进，您将已经在 RStudio 中设置了这个项目。如果没有，请按照上一章中的步骤创建一个标记为“life _ expectations”的新 RStudio。

## 组织数据集

我们要做的一件事是将数据读入项目。为了保持有序，创建一个文件夹来存储您的数据会有所帮助。使用文件查看器创建一个新文件夹，如图 [5-1](#Fig1) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig1_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig1_HTML.jpg)

图 5-1

创建新文件夹

转到文件，然后“新文件夹”键入单词“数据”，然后单击“确定”。现在，您将拥有一个与此项目相关联的新文件夹。

### 下载预期寿命数据

接下来，通过此链接转到数据集所在的页面:

```
https://catalog.data.gov/dataset/age-adjusted-death-rates-and-life-expectancy-at-birth-all-races-both-sexes-united-sta-1900

```

该页面将包括数据的详细描述。我们希望将 csv 文件下载到我们刚刚创建的“data”文件夹中。向下滚动到图 [5-2](#Fig2) 中所示的页面区域。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig2_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig2_HTML.jpg)

图 5-2

预期寿命 CSV 下载链接

点击“下载”按钮。csv 文件将出现在您的下载文件夹中。将 csv 文件从下载文件夹移动到您在项目中创建的数据文件夹。请注意，您必须使用电脑的 Finder 或 Explorer 应用程序来移动此文件。

### 将数据集添加到 R 项目

虽然我们将原始 csv 文件保存在 data 文件夹中，但我们需要 dataframe 格式的数据，以便在我们的分析中使用。读入这种格式数据的最简单方法是使用位于环境视图中的“导入数据集”功能，如图 [5-3](#Fig3) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig3_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig3_HTML.jpg)

图 5-3

导入数据集

进入“环境”视图，点击“导入数据集”，然后选择“从文本(readr)…”。将出现类似图 [5-4](#Fig4) 的屏幕。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig4_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig4_HTML.jpg)

图 5-4

数据导入小部件

使用“浏览”按钮导航到 csv 文件。这在屏幕右上角的图 [5-4](#Fig4) 中突出显示。dataframe 的默认名称将与文件相同，但由于这将会非常长，您可以在此小部件屏幕上更改它，如小部件左下角“name”旁边的突出显示区域所示。我们简单地将数据帧命名为“期望”。

一旦你完成了这个过程，dataframe 就会出现在你的 R Studio 项目中，如图 [5-5](#Fig5) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig5_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig5_HTML.jpg)

图 5-5

R Studio 项目中的数据帧

在图 [5-5](#Fig5) 中，你可以在左上角看到一个数据帧的样本。用于读入数据的代码将出现在控制台的左下方，该代码也将保留在历史视图中。最后，您将在右上角的“环境”窗口中看到一个名为“期望”的对象。如果您在某个时候关闭窗口，您可以单击此对象使数据再次出现。

这是设置项目的第一步。如果关闭 RStudio，请确保保存项目的状态。否则，如果要处理数据框，您需要再次重复此过程。

## r 代码文件

虽然一开始使用提供的小部件和交互式控制台屏幕可能很容易，但如果我们想重做我们的分析或请同事来运行我们的分析，则很难追溯我们的步骤。我们的分析确实不可重复。

为了使我们的工作具有可重复性，我们可以在项目中添加 R 脚本文件。我们现在要做的是添加一个 R 脚本文件，然后将自动生成的代码添加到该文件中，以便我们可以在图中重用它。

进入 RStudio 菜单栏，选择“文件”➤“新文件”➤“r 脚本”。一个如图 [5-6](#Fig6) 所示的新标签将出现在标记为“无标题 1”的数据框旁边。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig6_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig6_HTML.jpg)

图 5-6

r 脚本编辑器

这个脚本编辑器带有非常有用的内置特性，顶部还有一个可视化快捷方式栏。首先，我们将单击软盘图标，用一个容易记住的名称将该文件保存到我们的项目中。单击软盘图标，在出现的对话框中输入文件名“process_data”。r”。该文件现在将出现在您的文件资源管理器中，您可以随时通过单击其名称打开该文件。

当我们谈论代码工具时，我们将在这里查看其他功能，但现在请注意，我们可以在这里保存我们的工作，也可以使用上面的“运行”和“源”按钮运行代码。现在，我们想检索自动生成的代码，这些代码读入 csv 文件，然后在这个数据帧上做一些整理工作。

打开右侧的“历史”选项卡，您应该会看到用于读取 csv 文件的代码行，如图 [5-7](#Fig7) 所示。按住 Command 键点按以高亮显示前两行代码。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig7_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig7_HTML.jpg)

图 5-7

从历史选项卡中检索代码

单击“To Source”按钮将这段代码移动到您的 R 脚本文件中。然后点击软盘图标保存文件，如图 [5-8](#Fig8) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig8_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig8_HTML.jpg)

图 5-8

包含检索代码的 r 脚本文件

我们现在可以通过点击顶部的“Source”按钮在需要的时候重新运行这个步骤。此外，我们可以将这个项目发送给同事，她可以用同样的方式重新创建我们的工作，这样我们的分析就可以保持可重复性。

在我们继续之前，我们应该在代码中添加一些注释，并清理数据帧，以便以后更容易处理。下面的代码是如何做到这一点的一个例子:

```
# Import NCHS Dataset
# File download from:
#   https://catalog.data.gov
# Contains life expectancy data from 1900 in the US

library(readr)
expectancy <- read_csv("data/NCHS_-_Death_rates_and_life_expectancy_at_birth.csv")

# Clean up dataframe
# Use shorter column names

names(expectancy)[1] <- "year"
names(expectancy)[2] <- "race"
names(expectancy)[3] <- "sex"
names(expectancy)[4] <- "life_expectancy"
names(expectancy)[5] <- "death_rate"

```

#后面的是注释，R 代码的最后五行用更短的名称替换列名，这样更容易操作。不要忘记单击软盘图标将代码保存在这个文件中。

## 数据探索

当你开始一个新项目时，你可能想做的事情之一是做一些探索性的数据分析。我们已经可以直观地检查数据集，但如果有一个更完整的图片就更好了。我们也可能希望开始可视化更重要的数据点。

### 汇总数据帧

让我们创建一个新的 r 脚本文件，方法是转到 RStudio 菜单栏，选择“文件”➤“新文件”➤“r 脚本”。和以前一样，会出现一个新文件。单击软盘图标，以文件名“data_exploration”保存该文件。r”。

现在我们希望看到预期数据帧的摘要，所以我们可以使用带有数据帧的函数`summary`作为参数。

```
summary(expectancy)

```

将这个函数直接输入到您的 R 脚本文件中，然后单击“Run”按钮编写这段代码。您将看到描述每个变量(或数据帧的列)的输出，如图 [5-9](#Fig9) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig9_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig9_HTML.jpg)

图 5-9

数据帧摘要

图 [5-9](#Fig9) 中的信息向我们展示了这个数据集的很多信息。我们可以看到每列包含什么类型的数据，并且我们有一些关于数字数据的信息。例如，我们知道数据集涵盖 1900 年至 2015 年，有些年份的预期寿命为 29.10 岁，而有些年份为 81.4 岁。我们还可以看到，我们有两种性格类型种族和性别，但我们几乎没有关于这些的信息。这些是类别，将揭示这个数据集是如何组织的。

要查看种族和性别类别，我们可以使用 R unique 函数，并将数据列作为参数传递，如下所示:

```
unique(expectancy$race)

```

如果您点击“运行”按钮，您将看到以下输出:

```
[1] "All Races" "Black"     "White"

```

当你对性别类别做同样的操作时，你可以看到我们也有三个可用的类别:“两性”、“女性”和“男性”。

从所有这些可以看出，我们的数据将按三个类别组织:年份、种族和性别。此外，很可能每年都会有所有可用的种族和性别组合的行。您可以使用 dataframe 视图来验证这一点。

导航到项目中的第一个选项卡，再次查看预期数据框架。单击过滤器按钮查看数据的子集。如图 [5-10](#Fig10) 所示，使用年份列中的滑块仅查看由 1900 年标识的行。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig10_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig10_HTML.jpg)

图 5-10

过滤数据帧

既然我们知道了事物是如何组织的，我们就要小心处理这个数据帧。例如，我们不希望简单地按年汇总数据点，因为它包含重叠的类别，我们希望在开发研究问题时根据这些类别进行过滤。

你可能还想做一些初步的可视化，开始深入了解我们正在看的数字变量。例如，你可能会猜测，自 1900 年以来，预期寿命会增加。为了测试这一理论，您可以只查看数据帧中种族和性别类别值为“所有种族”和“两性”的行。

```
trend <- expectancy
trend <- trend[trend$race == "All Races", ]
trend <- trend[trend$sex == "Both Sexes", ]

```

首先，我们将预期数据帧分配给一个名为趋势的新数据帧。然后我们取数据的两个子集。第二行将返回种族等于“所有种族”的所有行，而第三行将返回性别等于“两性”的所有行。接下来，我们可以移除所有变量，除了我们要特别关注的变量。

```
trend$race <- NULL
trend$sex <- NULL
trend$death_rate <- NULL

```

在 R 中将对象设置为`NULL`会将它们从您的环境中移除。现在我们可以使用基数 R `plot`函数按年绘制预期寿命。

```
plot(trend)

```

这将自动绘制两个变量，图查看器将显示图，如图 [5-11](#Fig11) 所示。

![../images/478254_1_En_5_Chapter/478254_1_En_5_Fig11_HTML.jpg](../images/478254_1_En_5_Chapter/478254_1_En_5_Fig11_HTML.jpg)

图 5-11

按年份分列的预期寿命

正如你所看到的，这张图支持了我们最初的猜测，即预期寿命会随着时间的推移而增加。该图还显示，早些年的观察结果不如晚些年的观察结果一致。

## 结论

本章举例说明了如何使用 RStudio 项目来组织和重现您的作品。RStudio 项目使您可以轻松地追溯您的步骤，并在您充实您的分析时基于您的早期工作。此外，RStudio 项目使与同事分享工作变得更加容易。

当您在完成这样的项目后关闭 RStudio 时，请确保在 IDE 提示您退出时单击“保存”。这将保存您的工作和历史记录，并使您更容易从项目中停止的地方重新开始。